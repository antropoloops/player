{"ast":null,"code":"import debug from \"debug\";\nconst log = debug(\"atpls:keyboard\");\nexport class KeyboardControler {\n  constructor(audioset, control) {\n    this.control = control;\n    this.active = false;\n    this.pressed = {};\n    this.clipIdToKey = {};\n    this.keyToClipId = {};\n    this.mapMode = undefined;\n    audioset.clips.forEach(clip => {\n      const key = clip.keyMap.toUpperCase();\n      this.clipIdToKey[clip.id] = key;\n      this.keyToClipId[key] = clip.id;\n    });\n  }\n\n  getKey(clipId) {\n    return this.clipIdToKey[clipId];\n  }\n\n  setActive(isActive) {\n    this.active = isActive;\n    log(\"setActive %o\", isActive);\n  }\n\n  startMapMode(clipId, callback) {\n    this.mapMode = {\n      clipId,\n      callback\n    };\n  }\n\n  stopMapMode() {\n    this.mapMode = undefined;\n  }\n\n  setKey(clipId, key) {\n    const oldKey = this.clipIdToKey[clipId];\n\n    if (oldKey) {\n      this.keyToClipId[oldKey] = undefined;\n    }\n\n    key = key.toUpperCase();\n    this.keyToClipId[key] = clipId;\n    this.clipIdToKey[clipId] = key;\n  }\n\n  keyDown(key) {\n    if (!this.active) {\n      return;\n    }\n\n    key = key.toUpperCase();\n\n    if (this.mapMode) {\n      return this.handleKeymapChange(key);\n    } else if (this.pressed[key]) {\n      return;\n    }\n\n    this.pressed[key] = true;\n    const clipId = this.keyToClipId[key];\n\n    if (clipId) {\n      this.control.startClip(clipId, 0);\n    }\n  }\n\n  keyUp(key) {\n    if (!this.active || this.mapMode) {\n      return;\n    }\n\n    key = key.toUpperCase();\n    this.pressed[key] = false;\n    const clipId = this.keyToClipId[key];\n\n    if (clipId) {\n      this.control.stopClip(clipId, 0);\n    }\n  }\n\n  handleKeymapChange(key) {\n    if (!this.mapMode) {\n      return;\n    }\n\n    if (key !== \"ESCAPE\") {\n      this.setKey(this.mapMode.clipId, key);\n    }\n\n    this.mapMode.callback(key);\n    this.mapMode = undefined;\n  }\n\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/KeyboardControler.ts"],"names":["debug","log","KeyboardControler","constructor","audioset","control","active","pressed","clipIdToKey","keyToClipId","mapMode","undefined","clips","forEach","clip","key","keyMap","toUpperCase","id","getKey","clipId","setActive","isActive","startMapMode","callback","stopMapMode","setKey","oldKey","keyDown","handleKeymapChange","startClip","keyUp","stopClip"],"mappings":"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","sourcesContent":["import { Audioset } from \"../audioset\";\n\nimport debug from \"debug\";\n\nconst log = debug(\"atpls:keyboard\");\n\nexport interface KeyboardControl {\n  startClip(clipId: string, time: number): void;\n  stopClip(clipId: string, time: number): void;\n}\n\ntype MapModeCallback = (newKey: string) => void;\ninterface MapMode {\n  clipId: string;\n  callback: MapModeCallback;\n}\n\nexport class KeyboardControler {\n  private active: boolean = false;\n  private pressed: Record<string, boolean> = {};\n  private clipIdToKey: Record<string, string> = {};\n  private keyToClipId: Record<string, string | undefined> = {};\n  private mapMode?: MapMode = undefined;\n\n  constructor(audioset: Audioset, private control: Control) {\n    audioset.clips.forEach(clip => {\n      const key = clip.keyMap.toUpperCase();\n      this.clipIdToKey[clip.id] = key;\n      this.keyToClipId[key] = clip.id;\n    });\n  }\n\n  public getKey(clipId: string) {\n    return this.clipIdToKey[clipId];\n  }\n\n  public setActive(isActive: boolean) {\n    this.active = isActive;\n    log(\"setActive %o\", isActive);\n  }\n\n  public startMapMode(clipId: string, callback: MapModeCallback) {\n    this.mapMode = { clipId, callback };\n  }\n  public stopMapMode() {\n    this.mapMode = undefined;\n  }\n\n  public setKey(clipId: string, key: string) {\n    const oldKey = this.clipIdToKey[clipId];\n    if (oldKey) {\n      this.keyToClipId[oldKey] = undefined;\n    }\n    key = key.toUpperCase();\n    this.keyToClipId[key] = clipId;\n    this.clipIdToKey[clipId] = key;\n  }\n\n  public keyDown(key: string) {\n    if (!this.active) {\n      return;\n    }\n\n    key = key.toUpperCase();\n    if (this.mapMode) {\n      return this.handleKeymapChange(key);\n    } else if (this.pressed[key]) {\n      return;\n    }\n    this.pressed[key] = true;\n\n    const clipId = this.keyToClipId[key];\n    if (clipId) {\n      this.control.startClip(clipId, 0);\n    }\n  }\n  public keyUp(key: string) {\n    if (!this.active || this.mapMode) {\n      return;\n    }\n\n    key = key.toUpperCase();\n    this.pressed[key] = false;\n\n    const clipId = this.keyToClipId[key];\n    if (clipId) {\n      this.control.stopClip(clipId, 0);\n    }\n  }\n\n  private handleKeymapChange(key: string) {\n    if (!this.mapMode) {\n      return;\n    }\n    if (key !== \"ESCAPE\") {\n      this.setKey(this.mapMode.clipId, key);\n    }\n    this.mapMode.callback(key);\n    this.mapMode = undefined;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}