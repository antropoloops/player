{"ast":null,"code":"import _regeneratorRuntime from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _classCallCheck from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import debug from\"debug\";var log=debug(\"atpls:resources\");// TODO: abstract the loader mechanism: { status, payload }\nexport var ResourceLoader=/*#__PURE__*/function(){function ResourceLoader(audioset,listener){_classCallCheck(this,ResourceLoader);this.audioset=audioset;this.listener=listener;this.status=void 0;this.fetch=function(){return Promise.reject();};this.total=void 0;this.completed=void 0;this.buffers={};this.status={status:\"pending\"};this.total=this.audioset.clips.length;this.completed=0;}_createClass(ResourceLoader,[{key:\"getBuffer\",value:function getBuffer(clipId){return this.buffers[clipId];}},{key:\"load\",value:function load(){var _this=this;var total=this.total,completed=this.completed;if(total===completed)return;this._setStatus({status:\"loading\",total:total,completed:0});var clips=this.audioset.clips;var promises=clips.map(function(clip){return _this._loadAudio(clip).catch(function(err){_this._complete();log(\"Error %o\",err);});});return Promise.all(promises);}//// PRIVATE ////\n},{key:\"_setStatus\",value:function _setStatus(status){this.status=status;this.listener(status);}},{key:\"_loadAudio\",value:function(){var _loadAudio2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(clip){var url,buffer;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:// TODO: check other formats\nurl=clip.resources.audio.mp3;_context.next=3;return this.fetch(url);case 3:buffer=_context.sent;this.buffers[clip.id]=buffer;this._complete();return _context.abrupt(\"return\",buffer);case 7:case\"end\":return _context.stop();}}},_callee,this);}));function _loadAudio(_x){return _loadAudio2.apply(this,arguments);}return _loadAudio;}()},{key:\"_complete\",value:function _complete(){this.completed+=1;var status=this.completed===this.total?{status:\"ready\",total:this.total}:{status:\"loading\",total:this.total,completed:this.completed};this._setStatus(status);}}]);return ResourceLoader;}();","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/Player/ResourceLoader.ts"],"names":["debug","log","ResourceLoader","audioset","listener","status","fetch","Promise","reject","total","completed","buffers","clips","length","clipId","_setStatus","promises","map","clip","_loadAudio","catch","err","_complete","all","url","resources","audio","mp3","buffer","id"],"mappings":"2mBAAA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CAGA,GAAMC,CAAAA,GAAG,CAAGD,KAAK,CAAC,iBAAD,CAAjB,CAEA;AAUA,UAAaE,CAAAA,cAAb,yBAOE,wBAAoBC,QAApB,CAAgDC,QAAhD,CAAgG,2CAA5ED,QAA4E,CAA5EA,QAA4E,MAAhDC,QAAgD,CAAhDA,QAAgD,MANzFC,MAMyF,aALzFC,KAKyF,CALrE,iBAAMC,CAAAA,OAAO,CAACC,MAAR,EAAN,EAKqE,MAJxFC,KAIwF,aAHxFC,SAGwF,aAFxFC,OAEwF,CAFzD,EAEyD,CAC9F,KAAKN,MAAL,CAAc,CAAEA,MAAM,CAAE,SAAV,CAAd,CACA,KAAKI,KAAL,CAAa,KAAKN,QAAL,CAAcS,KAAd,CAAoBC,MAAjC,CACA,KAAKH,SAAL,CAAiB,CAAjB,CACD,CAXH,uEAamBI,MAbnB,CAawC,CACpC,MAAO,MAAKH,OAAL,CAAaG,MAAb,CAAP,CACD,CAfH,mCAiBgB,mBACJL,CAAAA,KADI,CACiB,IADjB,CACJA,KADI,CACGC,SADH,CACiB,IADjB,CACGA,SADH,CAEZ,GAAID,KAAK,GAAKC,SAAd,CAAyB,OAEzB,KAAKK,UAAL,CAAgB,CAAEV,MAAM,CAAE,SAAV,CAAqBI,KAAK,CAALA,KAArB,CAA4BC,SAAS,CAAE,CAAvC,CAAhB,EACA,GAAME,CAAAA,KAAK,CAAG,KAAKT,QAAL,CAAcS,KAA5B,CACA,GAAMI,CAAAA,QAAQ,CAAGJ,KAAK,CAACK,GAAN,CAAU,SAACC,IAAD,QACzB,CAAA,KAAI,CAACC,UAAL,CAAgBD,IAAhB,EAAsBE,KAAtB,CAA4B,SAACC,GAAD,CAAS,CACnC,KAAI,CAACC,SAAL,GACArB,GAAG,CAAC,UAAD,CAAaoB,GAAb,CAAH,CACD,CAHD,CADyB,EAAV,CAAjB,CAMA,MAAOd,CAAAA,OAAO,CAACgB,GAAR,CAAYP,QAAZ,CAAP,CACD,CAED;AAhCF,8CAiCqBX,MAjCrB,CAiCiD,CAC7C,KAAKA,MAAL,CAAcA,MAAd,CACA,KAAKD,QAAL,CAAcC,MAAd,EACD,CApCH,8HAsC2Ba,IAtC3B,iIAuCI;AACMM,GAxCV,CAwCgBN,IAAI,CAACO,SAAL,CAAeC,KAAf,CAAqBC,GAxCrC,uBAyCyB,MAAKrB,KAAL,CAAWkB,GAAX,CAzCzB,QAyCUI,MAzCV,eA0CI,KAAKjB,OAAL,CAAaO,IAAI,CAACW,EAAlB,EAAwBD,MAAxB,CACA,KAAKN,SAAL,GA3CJ,gCA6CWM,MA7CX,oMAgDsB,CAClB,KAAKlB,SAAL,EAAkB,CAAlB,CACA,GAAML,CAAAA,MAA0B,CAC9B,KAAKK,SAAL,GAAmB,KAAKD,KAAxB,CACI,CAAEJ,MAAM,CAAE,OAAV,CAAmBI,KAAK,CAAE,KAAKA,KAA/B,CADJ,CAEI,CAAEJ,MAAM,CAAE,SAAV,CAAqBI,KAAK,CAAE,KAAKA,KAAjC,CAAwCC,SAAS,CAAE,KAAKA,SAAxD,CAHN,CAIA,KAAKK,UAAL,CAAgBV,MAAhB,EACD,CAvDH","sourcesContent":["import debug from \"debug\";\nimport { Audioset, Clip } from \"../Audioset\";\n\nconst log = debug(\"atpls:resources\");\n\n// TODO: abstract the loader mechanism: { status, payload }\ntype LoadPending = { status: \"pending\" };\ntype LoadingResources = { status: \"loading\"; total: number; completed: number };\ntype ResourcesLoaded = { status: \"ready\"; total: number };\ntype ResourceLoadError = { status: \"error\"; error: any };\n\nexport type ResourceLoadStatus = LoadPending | LoadingResources | ResourcesLoaded | ResourceLoadError;\n\nexport type FetchAudio = (url: string) => Promise<any>;\n\nexport class ResourceLoader {\n  public status: ResourceLoadStatus;\n  public fetch: FetchAudio = () => Promise.reject();\n  private total: number;\n  private completed: number;\n  private buffers: Record<string, any> = {};\n\n  constructor(private audioset: Audioset, private listener: (status: ResourceLoadStatus) => void) {\n    this.status = { status: \"pending\" };\n    this.total = this.audioset.clips.length;\n    this.completed = 0;\n  }\n\n  public getBuffer(clipId: string): any {\n    return this.buffers[clipId];\n  }\n\n  public load() {\n    const { total, completed } = this;\n    if (total === completed) return;\n\n    this._setStatus({ status: \"loading\", total, completed: 0 });\n    const clips = this.audioset.clips;\n    const promises = clips.map((clip) =>\n      this._loadAudio(clip).catch((err) => {\n        this._complete();\n        log(\"Error %o\", err);\n      }),\n    );\n    return Promise.all(promises);\n  }\n\n  //// PRIVATE ////\n  private _setStatus(status: ResourceLoadStatus) {\n    this.status = status;\n    this.listener(status);\n  }\n\n  private async _loadAudio(clip: Clip) {\n    // TODO: check other formats\n    const url = clip.resources.audio.mp3;\n    const buffer = await this.fetch(url);\n    this.buffers[clip.id] = buffer;\n    this._complete();\n\n    return buffer;\n  }\n\n  private _complete() {\n    this.completed += 1;\n    const status: ResourceLoadStatus =\n      this.completed === this.total\n        ? { status: \"ready\", total: this.total }\n        : { status: \"loading\", total: this.total, completed: this.completed };\n    this._setStatus(status);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}