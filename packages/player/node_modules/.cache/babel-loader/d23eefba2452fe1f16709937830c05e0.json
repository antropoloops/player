{"ast":null,"code":"import _defineProperty from \"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport debug from \"debug\";\nimport { KeyboardControler } from \"./KeyboardControler\";\nconst log = debug(\"atpls:control\");\n\n/**\n * Controls the playing state of clips and tracks\n */\nexport class AudiosetControl {\n  constructor(audioset, listener) {\n    this.listener = listener;\n    this.keyboard = void 0;\n    this.clipStateByClipId = {};\n    this.trackStateByTrackId = {};\n    this.clipIdsOfTrack = {};\n    this.trackIdOfClip = {};\n    this.commands = [];\n    this.playingClipsCount = 0;\n    this.playingTracksCount = 0;\n    log(\"create control\");\n    this.keyboard = new KeyboardControler(audioset, this);\n    audioset.clips.forEach(clip => {\n      this.clipStateByClipId[clip.id] = {\n        state: \"stopped\"\n      };\n      this.trackIdOfClip[clip.id] = clip.trackId;\n    });\n    audioset.tracks.forEach(track => {\n      const volume = track.volume || 1;\n      this.trackStateByTrackId[track.id] = {\n        state: \"stopped\",\n        volume\n      };\n      this.clipIdsOfTrack[track.id] = track.clipIds;\n    });\n  }\n\n  toggleClip(clipId, time) {\n    const clipState = this.clipStateByClipId[clipId];\n\n    if (!clipState) {\n      return;\n    } else if (clipState.state === \"stopped\") {\n      this.startClip(clipId, time);\n    } else if (clipState.state === \"playing\") {\n      this.stopClip(clipId, time);\n    }\n  }\n  /**\n   * Start a clip\n   * @param clipId\n   */\n\n\n  startClip(clipId, time) {\n    const clipState = this.clipStateByClipId[clipId];\n\n    if (!clipState || clipState.state === \"playing\") {\n      return;\n    }\n\n    const trackId = this.trackIdOfClip[clipId];\n    const sameTrackClipIds = this.clipIdsOfTrack[trackId];\n    this.applyEffectsAndSendCommands(() => {\n      sameTrackClipIds.forEach(trackClipId => this._stopClip(trackClipId, time));\n\n      this._startTrack(trackId, time);\n\n      this.startClipCommand(clipId, time);\n    });\n  }\n  /**\n   * Stops a clip\n   */\n\n\n  stopClip(clipId, time) {\n    const clipState = this.clipStateByClipId[clipId];\n\n    if (!clipState || clipState.state === \"stopped\") {\n      return;\n    }\n\n    const trackId = this.trackIdOfClip[clipId];\n    this.applyEffectsAndSendCommands(() => {\n      this._stopClip(clipId, time);\n\n      this._stopTrack(trackId, time);\n    });\n  }\n  /**\n   * Stops all clips\n   */\n\n\n  stopAll(time) {\n    this.applyEffectsAndSendCommands(() => {\n      Object.keys(this.clipStateByClipId).forEach(clipId => this._stopClip(clipId, time));\n      Object.keys(this.trackStateByTrackId).forEach(trackId => this._stopTrack(trackId, time));\n    });\n  }\n\n  getState() {\n    return {\n      playingClipsCount: this.playingClipsCount,\n      playingTracksCount: this.playingTracksCount,\n      clips: _objectSpread({}, this.clipStateByClipId),\n      tracks: _objectSpread({}, this.trackStateByTrackId)\n    };\n  } //// PRIVATE ////\n\n\n  applyEffectsAndSendCommands(effects) {\n    effects();\n    this.commands.forEach(command => {\n      this.listener.onControlCommand(command);\n    });\n    this.commands = [];\n    this.listener.onControlStateChanged(this.getState());\n  }\n\n  startClipCommand(clipId, time) {\n    if (this.clipStateByClipId[clipId].state === \"playing\") {\n      return;\n    }\n\n    this.playingClipsCount += 1;\n    this.clipStateByClipId[clipId] = {\n      state: \"playing\"\n    };\n    this.commands.push({\n      command: \"startClip\",\n      clipId,\n      time\n    });\n  }\n\n  _stopClip(clipId, time) {\n    if (this.clipStateByClipId[clipId].state === \"stopped\") {\n      return;\n    }\n\n    this.playingClipsCount -= 1;\n    this.clipStateByClipId[clipId] = {\n      state: \"stopped\"\n    };\n    this.commands.push({\n      command: \"stopClip\",\n      clipId,\n      time\n    });\n  }\n\n  _startTrack(trackId, time) {\n    const trackState = this.trackStateByTrackId[trackId];\n\n    if (trackState.state === \"playing\") {\n      return;\n    }\n\n    this.playingTracksCount += 1;\n    this.trackStateByTrackId[trackId] = {\n      state: \"playing\",\n      volume: trackState.volume\n    };\n    this.commands.push({\n      command: \"startTrack\",\n      trackId,\n      time\n    });\n  }\n\n  _stopTrack(trackId, time) {\n    const trackState = this.trackStateByTrackId[trackId];\n\n    if (trackState.state === \"stopped\") {\n      return;\n    }\n\n    this.playingTracksCount -= 1;\n    this.trackStateByTrackId[trackId] = {\n      state: \"stopped\",\n      volume: trackState.volume\n    };\n    this.commands.push({\n      command: \"stopTrack\",\n      trackId,\n      time\n    });\n  }\n\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/AudiosetControl.ts"],"names":["debug","KeyboardControler","log","AudiosetControl","constructor","audioset","listener","keyboard","clipStateByClipId","trackStateByTrackId","clipIdsOfTrack","trackIdOfClip","commands","playingClipsCount","playingTracksCount","clips","forEach","clip","id","state","trackId","tracks","track","volume","clipIds","toggleClip","clipId","time","clipState","startClip","stopClip","sameTrackClipIds","applyEffectsAndSendCommands","trackClipId","_stopClip","_startTrack","startClipCommand","_stopTrack","stopAll","Object","keys","getState","effects","command","onControlCommand","onControlStateChanged","push","trackState"],"mappings":"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","sourcesContent":["import debug from \"debug\";\nimport { Audioset, Clip } from \"../audioset\";\nimport { KeyboardControler } from \"./KeyboardControler\";\n\nconst log = debug(\"atpls:control\");\n\nexport type PlayingState = \"stopped\" | \"playing\"; // | \"playScheduled\" |  \"stopScheduled\";\n\nexport interface ClipPlayingState {\n  readonly state: PlayingState;\n}\n\nexport interface TrackPlayingState {\n  readonly state: PlayingState;\n  readonly volume: number;\n}\n\nexport interface StartClip {\n  command: \"startClip\";\n  clipId: string;\n  time: number;\n}\nexport interface StopClip {\n  command: \"stopClip\";\n  clipId: string;\n  time: number;\n}\nexport interface StartTrack {\n  command: \"startTrack\";\n  trackId: string;\n  time: number;\n}\nexport interface StopTrack {\n  command: \"stopTrack\";\n  trackId: string;\n  time: number;\n}\n\nexport type ControlCommand = StartClip | StopClip | StartTrack | StopTrack;\n\ntype ClipPlayingStateByClipId = Record<string, ClipPlayingState>;\ntype TrackPlayingStateByTrackId = Record<string, TrackPlayingState>;\n\nexport interface ControlState {\n  playingClipsCount: number;\n  playingTracksCount: number;\n  clips: ClipPlayingStateByClipId;\n  tracks: TrackPlayingStateByTrackId;\n}\n\nexport interface ControlListener {\n  onControlStateChanged: (state: ControlState) => void;\n  onControlCommand: (command: ControlCommand) => void;\n}\n\n/**\n * Controls the playing state of clips and tracks\n */\nexport class AudiosetControl {\n  public readonly keyboard: KeyboardControler;\n  private clipStateByClipId: ClipPlayingStateByClipId = {};\n  private trackStateByTrackId: TrackPlayingStateByTrackId = {};\n  private clipIdsOfTrack: Record<string, string[]> = {};\n  private trackIdOfClip: Record<string, string> = {};\n  private commands: ControlCommand[] = [];\n  private playingClipsCount: number = 0;\n  private playingTracksCount: number = 0;\n\n  constructor(audioset: Audioset, private listener: ControlListener) {\n    log(\"create control\");\n    this.keyboard = new KeyboardControler(audioset, this);\n    audioset.clips.forEach((clip: Clip) => {\n      this.clipStateByClipId[clip.id] = { state: \"stopped\" };\n      this.trackIdOfClip[clip.id] = clip.trackId;\n    });\n    audioset.tracks.forEach(track => {\n      const volume = track.volume || 1;\n      this.trackStateByTrackId[track.id] = { state: \"stopped\", volume };\n      this.clipIdsOfTrack[track.id] = track.clipIds;\n    });\n  }\n\n  public toggleClip(clipId: string, time: number) {\n    const clipState = this.clipStateByClipId[clipId];\n    if (!clipState) {\n      return;\n    } else if (clipState.state === \"stopped\") {\n      this.startClip(clipId, time);\n    } else if (clipState.state === \"playing\") {\n      this.stopClip(clipId, time);\n    }\n  }\n\n  /**\n   * Start a clip\n   * @param clipId\n   */\n  public startClip(clipId: string, time: number) {\n    const clipState = this.clipStateByClipId[clipId];\n    if (!clipState || clipState.state === \"playing\") {\n      return;\n    }\n\n    const trackId = this.trackIdOfClip[clipId];\n    const sameTrackClipIds = this.clipIdsOfTrack[trackId];\n    this.applyEffectsAndSendCommands(() => {\n      sameTrackClipIds.forEach(trackClipId =>\n        this._stopClip(trackClipId, time),\n      );\n      this._startTrack(trackId, time);\n      this.startClipCommand(clipId, time);\n    });\n  }\n\n  /**\n   * Stops a clip\n   */\n  public stopClip(clipId: string, time: number) {\n    const clipState = this.clipStateByClipId[clipId];\n    if (!clipState || clipState.state === \"stopped\") {\n      return;\n    }\n\n    const trackId = this.trackIdOfClip[clipId];\n\n    this.applyEffectsAndSendCommands(() => {\n      this._stopClip(clipId, time);\n      this._stopTrack(trackId, time);\n    });\n  }\n\n  /**\n   * Stops all clips\n   */\n  public stopAll(time: number) {\n    this.applyEffectsAndSendCommands(() => {\n      Object.keys(this.clipStateByClipId).forEach(clipId =>\n        this._stopClip(clipId, time),\n      );\n      Object.keys(this.trackStateByTrackId).forEach(trackId =>\n        this._stopTrack(trackId, time),\n      );\n    });\n  }\n\n  public getState(): ControlState {\n    return {\n      playingClipsCount: this.playingClipsCount,\n      playingTracksCount: this.playingTracksCount,\n      clips: { ...this.clipStateByClipId },\n      tracks: { ...this.trackStateByTrackId },\n    };\n  }\n\n  //// PRIVATE ////\n  private applyEffectsAndSendCommands(effects: () => void) {\n    effects();\n\n    this.commands.forEach(command => {\n      this.listener.onControlCommand(command);\n    });\n    this.commands = [];\n\n    this.listener.onControlStateChanged(this.getState());\n  }\n\n  private startClipCommand(clipId: string, time: number) {\n    if (this.clipStateByClipId[clipId].state === \"playing\") {\n      return;\n    }\n\n    this.playingClipsCount += 1;\n    this.clipStateByClipId[clipId] = { state: \"playing\" };\n    this.commands.push({ command: \"startClip\", clipId, time });\n  }\n  private _stopClip(clipId: string, time: number) {\n    if (this.clipStateByClipId[clipId].state === \"stopped\") {\n      return;\n    }\n\n    this.playingClipsCount -= 1;\n    this.clipStateByClipId[clipId] = { state: \"stopped\" };\n    this.commands.push({ command: \"stopClip\", clipId, time });\n  }\n  private _startTrack(trackId: string, time: number) {\n    const trackState = this.trackStateByTrackId[trackId];\n    if (trackState.state === \"playing\") {\n      return;\n    }\n\n    this.playingTracksCount += 1;\n    this.trackStateByTrackId[trackId] = {\n      state: \"playing\",\n      volume: trackState.volume,\n    };\n    this.commands.push({ command: \"startTrack\", trackId, time });\n  }\n  private _stopTrack(trackId: string, time: number) {\n    const trackState = this.trackStateByTrackId[trackId];\n    if (trackState.state === \"stopped\") {\n      return;\n    }\n\n    this.playingTracksCount -= 1;\n    this.trackStateByTrackId[trackId] = {\n      state: \"stopped\",\n      volume: trackState.volume,\n    };\n    this.commands.push({ command: \"stopTrack\", trackId, time });\n  }\n}\n"]},"metadata":{},"sourceType":"module"}