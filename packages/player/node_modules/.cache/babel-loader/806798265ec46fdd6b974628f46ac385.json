{"ast":null,"code":"import { EmptyAudioset, isAudioset } from \"../audioset\";\nimport { AudiosetLoader } from \"../audioset/AudiosetLoader\";\nimport { DebugAudioEngine } from \"./Audio\";\nimport { AudiosetControl } from \"./AudiosetControl\";\nimport { Emitter } from \"./Emitter\";\nimport { ResourceLoader } from \"./ResourceLoader\";\nimport { Sampler } from \"./Sampler\";\n\nconst NoOp = param => undefined;\n\nconst NoControl = new AudiosetControl(EmptyAudioset, {\n  onControlCommand: NoOp,\n  onControlStateChanged: NoOp\n});\nconst NoResources = new ResourceLoader(EmptyAudioset, NoOp);\nconst NoEngine = new DebugAudioEngine();\nconst NoSampler = new Sampler(EmptyAudioset, NoResources, NoEngine);\nconst NoPlayer = {\n  control: NoControl,\n  resources: NoResources,\n  sampler: NoSampler\n};\n/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */\n\nclass AudiosetPlayer {\n  constructor() {\n    this.resources = NoResources;\n    this.audioset = EmptyAudioset;\n    this.resourceListener = void 0;\n    this.resourceStatusChanged = new Emitter();\n\n    this.resourceListener = status => {\n      this.handleResourceChanged(status);\n    };\n  }\n\n  getAudioset() {\n    return this.audioset;\n  }\n\n  setAudioset(audioset) {\n    this.audioset = audioset;\n    this.resources = new ResourceLoader(audioset, this.resourceListener);\n  }\n\n  onResourceStatusChanged(listener) {\n    return this.resourceStatusChanged.on(listener);\n  } // PRIVATE //\n\n\n  handleResourceChanged(status) {\n    this.resourceStatusChanged.emit(status);\n  }\n\n}\n\nexport class ControlPlayer extends AudiosetPlayer {\n  constructor() {\n    super();\n    this.control = NoControl;\n    this.controlListener = void 0;\n    this.stateEvent = new Emitter();\n    this.controlCommandEvent = new Emitter();\n    this.controlListener = {\n      onControlStateChanged: state => this.handleControlStateChanged(state),\n      onControlCommand: command => this.handleControlCommand(command)\n    };\n  }\n  /**\n   * @override\n   */\n\n\n  setAudioset(audioset) {\n    this.control = new AudiosetControl(audioset, this.controlListener);\n    super.setAudioset(audioset);\n  }\n\n  onControlStateChanged(listener) {\n    return this.stateEvent.on(listener);\n  }\n\n  onCommand(listener) {\n    return this.controlCommandEvent.on(listener);\n  }\n\n  handleControlCommand(command) {\n    this.controlCommandEvent.emit(command);\n  }\n\n  handleControlStateChanged(controlState) {\n    this.stateEvent.emit(controlState);\n  }\n\n}\n\nclass AudioPlayer extends ControlPlayer {\n  constructor() {\n    super();\n    this.audio = new DebugAudioEngine();\n    this.sampler = NoSampler;\n    this.sampler = NoSampler;\n  }\n  /**\n   * @override\n   */\n\n\n  setAudioset(audioset) {\n    this.sampler = new Sampler(audioset, this.resources, this.audio);\n    super.setAudioset(audioset);\n  }\n\n  setAudioEngine(audio) {\n    this.audio = audio; // this.sampler.dispose()\n\n    this.sampler = new Sampler(this.getAudioset(), this.resources, this.audio);\n  }\n\n  handleControlCommand(command) {\n    this.sampler.run(command);\n    super.handleControlCommand(command);\n  }\n\n}\n/**\n * A player with a audioset loader.\n * The idea is a player with state, but not well modelled\n */\n\n\nexport class PlayerState extends AudioPlayer {\n  constructor() {\n    super();\n    this.loader = void 0;\n    this.audiosetLoadStatusChanged = new Emitter();\n    this.loader = new AudiosetLoader(status => this.handleLoadStatusChanged(status));\n  }\n\n  handleLoadStatusChanged(status) {\n    this.audiosetLoadStatusChanged.emit(status);\n\n    if (status.stage === \"ready\") {\n      this.setAudiosetBundle(status.audioset);\n    }\n  }\n\n  setAudiosetBundle(bundle) {\n    this.control.stopAll(0);\n\n    if (isAudioset(bundle)) {\n      this.setAudioset(bundle);\n    } else {\n      Object.assign(this, NoPlayer);\n    }\n  }\n\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/Player.ts"],"names":["EmptyAudioset","isAudioset","AudiosetLoader","DebugAudioEngine","AudiosetControl","Emitter","ResourceLoader","Sampler","NoOp","param","undefined","NoControl","onControlCommand","onControlStateChanged","NoResources","NoEngine","NoSampler","NoPlayer","control","resources","sampler","AudiosetPlayer","constructor","audioset","resourceListener","resourceStatusChanged","status","handleResourceChanged","getAudioset","setAudioset","onResourceStatusChanged","listener","on","emit","ControlPlayer","controlListener","stateEvent","controlCommandEvent","state","handleControlStateChanged","command","handleControlCommand","onCommand","controlState","AudioPlayer","audio","setAudioEngine","run","PlayerState","loader","audiosetLoadStatusChanged","handleLoadStatusChanged","stage","setAudiosetBundle","bundle","stopAll","Object","assign"],"mappings":"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","sourcesContent":["import {\n  Audioset,\n  AudiosetBundle,\n  EmptyAudioset,\n  isAudioset,\n} from \"../audioset\";\nimport { AudiosetLoader, AudiosetLoadStatus } from \"../audioset/AudiosetLoader\";\nimport { AudioEngine, DebugAudioEngine } from \"./Audio\";\nimport {\n  AudiosetControl,\n  ControlCommand,\n  ControlListener,\n  ControlState,\n} from \"./AudiosetControl\";\nimport { Emitter, Listener, Unsubscribe } from \"./Emitter\";\nimport {\n  ResourceLoader,\n  ResourceLoadStatus,\n  Resources,\n} from \"./ResourceLoader\";\nimport { Sampler } from \"./Sampler\";\n\nconst NoOp = (param: any) => undefined;\nconst NoControl = new AudiosetControl(EmptyAudioset, {\n  onControlCommand: NoOp,\n  onControlStateChanged: NoOp,\n});\nconst NoResources = new ResourceLoader(EmptyAudioset, NoOp);\nconst NoEngine = new DebugAudioEngine();\nconst NoSampler = new Sampler(EmptyAudioset, NoResources, NoEngine);\n\nconst NoPlayer = {\n  control: NoControl,\n  resources: NoResources,\n  sampler: NoSampler,\n};\n\n/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */\nexport interface Player {\n  readonly loader: AudiosetLoader;\n  readonly resources: Resources;\n  readonly control: AudiosetControl;\n  setAudioEngine(audio: AudioEngine): void;\n  onControlStateChanged(listener: Listener<ControlState>): Unsubscribe;\n  onResourceStatusChanged(listener: Listener<ResourceLoadStatus>): Unsubscribe;\n  onCommand(listener: Listener<ControlCommand>): Unsubscribe;\n}\n\nclass AudiosetPlayer {\n  public resources: Resources = NoResources;\n  private audioset: Audioset = EmptyAudioset;\n  private readonly resourceListener: (status: ResourceLoadStatus) => void;\n  private readonly resourceStatusChanged = new Emitter<ResourceLoadStatus>();\n\n  public constructor() {\n    this.resourceListener = (status: ResourceLoadStatus) => {\n      this.handleResourceChanged(status);\n    };\n  }\n\n  public getAudioset() {\n    return this.audioset;\n  }\n\n  public setAudioset(audioset: Audioset) {\n    this.audioset = audioset;\n    this.resources = new ResourceLoader(audioset, this.resourceListener);\n  }\n\n  public onResourceStatusChanged(listener: Listener<ResourceLoadStatus>) {\n    return this.resourceStatusChanged.on(listener);\n  }\n\n  // PRIVATE //\n  private handleResourceChanged(status: ResourceLoadStatus) {\n    this.resourceStatusChanged.emit(status);\n  }\n}\n\nexport class ControlPlayer extends AudiosetPlayer {\n  public control: AudiosetControl = NoControl;\n  protected readonly controlListener: ControlListener;\n\n  private readonly stateEvent = new Emitter<ControlState>();\n  private readonly controlCommandEvent = new Emitter<ControlCommand>();\n\n  constructor() {\n    super();\n    this.controlListener = {\n      onControlStateChanged: state => this.handleControlStateChanged(state),\n      onControlCommand: command => this.handleControlCommand(command),\n    };\n  }\n\n  /**\n   * @override\n   */\n  public setAudioset(audioset: Audioset) {\n      this.control = new AudiosetControl(audioset, this.controlListener);\n    super.setAudioset(audioset);\n  }\n\n  public onControlStateChanged(listener: Listener<ControlState>) {\n    return this.stateEvent.on(listener);\n  }\n\n  public onCommand(listener: Listener<ControlCommand>) {\n    return this.controlCommandEvent.on(listener);\n  }\n\n  protected handleControlCommand(command: ControlCommand) {\n    this.controlCommandEvent.emit(command);\n  }\n\n  private handleControlStateChanged(controlState: ControlState) {\n    this.stateEvent.emit(controlState);\n  }\n}\n\nclass AudioPlayer extends ControlPlayer {\n  protected audio: AudioEngine = new DebugAudioEngine();\n  private sampler: Sampler = NoSampler;\n\n  constructor() {\n    super();\n    this.sampler = NoSampler;\n  }\n\n  /**\n   * @override\n   */\n  public setAudioset(audioset: Audioset) {\n    this.sampler = new Sampler(audioset, this.resources, this.audio);\n    super.setAudioset(audioset);\n  }\n\n  public setAudioEngine(audio: AudioEngine) {\n    this.audio = audio;\n    // this.sampler.dispose()\n    this.sampler = new Sampler(this.getAudioset(), this.resources, this.audio);\n  }\n  protected handleControlCommand(command: ControlCommand) {\n    this.sampler.run(command);\n    super.handleControlCommand(command);\n  }\n}\n\n/**\n * A player with a audioset loader.\n * The idea is a player with state, but not well modelled\n */\nexport class PlayerState extends AudioPlayer implements Player {\n  public readonly loader: AudiosetLoader;\n  private readonly audiosetLoadStatusChanged = new Emitter<\n    AudiosetLoadStatus\n  >();\n\n  constructor() {\n    super();\n    this.loader = new AudiosetLoader(status =>\n      this.handleLoadStatusChanged(status),\n    );\n  }\n\n  private handleLoadStatusChanged(status: AudiosetLoadStatus) {\n    this.audiosetLoadStatusChanged.emit(status);\n    if (status.stage === \"ready\") {\n      this.setAudiosetBundle(status.audioset);\n    }\n  }\n\n  private setAudiosetBundle(bundle: AudiosetBundle) {\n    this.control.stopAll(0);\n    if (isAudioset(bundle)) {\n      this.setAudioset(bundle);\n    } else {\n      Object.assign(this, NoPlayer);\n    }\n  }\n}\n\n"]},"metadata":{},"sourceType":"module"}