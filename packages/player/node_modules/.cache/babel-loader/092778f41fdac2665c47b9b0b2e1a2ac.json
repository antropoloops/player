{"ast":null,"code":"import debug from \"debug\";\nimport { addResizeObserver } from \"../add-resize-observer\";\nimport { Visuals } from \"../visuals\";\nconst log = debug(\"atpls:visuals\");\nexport function createVisualEffects(audioset) {\n  return new VisualEffects(audioset);\n}\n\nclass VisualEffects {\n  constructor(audioset) {\n    this.audioset = audioset;\n    this.visuals = void 0;\n  }\n\n  attach(el) {\n    this.detach();\n    this.visuals = new Visuals(this.audioset, el);\n    setupVisuals(this.audioset, this.visuals);\n\n    const resize = (width, height) => {\n      if (this.visuals) {\n        this.visuals.resizeSvg(width, height);\n      }\n    };\n\n    this.detach = addResizeObserver(el, resize);\n  }\n\n  detach() {// Attach replaces this method\n  }\n\n  run(command) {\n    if (this.visuals) {\n      switch (command.command) {\n        case \"startClip\":\n          return this.visuals.show(command.clipId);\n\n        case \"stopClip\":\n          return this.visuals.hide(command.clipId);\n      }\n    }\n  }\n\n} // TODO: this should be part of resource loader\n\n\nfunction setupVisuals(audioset, visuals) {\n  if (audioset.visuals.mode === \"map\") {\n    // TODO: remove it when found a solution for mobile / desktop\n    return fetchGeomap(audioset.visuals.geomap.url).then(data => visuals.setGeodata(data)).then(() => visuals);\n  } else {\n    visuals.setup();\n    return Promise.resolve(visuals);\n  }\n}\n\nfunction fetchGeomap(url) {\n  log(\"Geomap url %s\", url);\n  return fetch(url).then(response => response.json());\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/VisualEffects.ts"],"names":["debug","addResizeObserver","Visuals","log","createVisualEffects","audioset","VisualEffects","constructor","visuals","attach","el","detach","setupVisuals","resize","width","height","resizeSvg","run","command","show","clipId","hide","mode","fetchGeomap","geomap","url","then","data","setGeodata","setup","Promise","resolve","fetch","response","json"],"mappings":"AAAA,OAAOA,KAAP,MAAkB,OAAlB;AACA,SAASC,iBAAT,QAAkC,wBAAlC;AAEA,SAASC,OAAT,QAAwB,YAAxB;AAIA,MAAMC,GAAG,GAAGH,KAAK,CAAC,eAAD,CAAjB;AAEA,OAAO,SAASI,mBAAT,CAA6BC,QAA7B,EAA0D;AAC/D,SAAO,IAAIC,aAAJ,CAAkBD,QAAlB,CAAP;AACD;;AAED,MAAMC,aAAN,CAAuC;AAErCC,EAAAA,WAAW,CAAUF,QAAV,EAA8B;AAAA,SAApBA,QAAoB,GAApBA,QAAoB;AAAA,SADjCG,OACiC;AAAE;;AAEpCC,EAAAA,MAAP,CAAcC,EAAd,EAA6B;AAC3B,SAAKC,MAAL;AACA,SAAKH,OAAL,GAAe,IAAIN,OAAJ,CAAY,KAAKG,QAAjB,EAA2BK,EAA3B,CAAf;AACAE,IAAAA,YAAY,CAAC,KAAKP,QAAN,EAAgB,KAAKG,OAArB,CAAZ;;AACA,UAAMK,MAAM,GAAG,CAACC,KAAD,EAAgBC,MAAhB,KAAmC;AAChD,UAAI,KAAKP,OAAT,EAAkB;AAChB,aAAKA,OAAL,CAAaQ,SAAb,CAAuBF,KAAvB,EAA8BC,MAA9B;AACD;AACF,KAJD;;AAKA,SAAKJ,MAAL,GAAcV,iBAAiB,CAACS,EAAD,EAAKG,MAAL,CAA/B;AACD;;AACMF,EAAAA,MAAP,GAAsB,CACpB;AACD;;AACMM,EAAAA,GAAP,CAAWC,OAAX,EAA0C;AACxC,QAAI,KAAKV,OAAT,EAAkB;AAChB,cAAQU,OAAO,CAACA,OAAhB;AACE,aAAK,WAAL;AACE,iBAAO,KAAKV,OAAL,CAAaW,IAAb,CAAkBD,OAAO,CAACE,MAA1B,CAAP;;AACF,aAAK,UAAL;AACE,iBAAO,KAAKZ,OAAL,CAAaa,IAAb,CAAkBH,OAAO,CAACE,MAA1B,CAAP;AAJJ;AAMD;AACF;;AA3BoC,C,CA8BvC;;;AACA,SAASR,YAAT,CAAsBP,QAAtB,EAA0CG,OAA1C,EAA8E;AAC5E,MAAIH,QAAQ,CAACG,OAAT,CAAiBc,IAAjB,KAA0B,KAA9B,EAAqC;AACnC;AACA,WAAOC,WAAW,CAAClB,QAAQ,CAACG,OAAT,CAAiBgB,MAAjB,CAAwBC,GAAzB,CAAX,CACJC,IADI,CACEC,IAAD,IAAkBnB,OAAO,CAACoB,UAAR,CAAmBD,IAAnB,CADnB,EAEJD,IAFI,CAEC,MAAMlB,OAFP,CAAP;AAGD,GALD,MAKO;AACLA,IAAAA,OAAO,CAACqB,KAAR;AACA,WAAOC,OAAO,CAACC,OAAR,CAAgBvB,OAAhB,CAAP;AACD;AACF;;AAED,SAASe,WAAT,CAAqBE,GAArB,EAAmD;AACjDtB,EAAAA,GAAG,CAAC,eAAD,EAAkBsB,GAAlB,CAAH;AAEA,SAAOO,KAAK,CAACP,GAAD,CAAL,CAAWC,IAAX,CAAgBO,QAAQ,IAAIA,QAAQ,CAACC,IAAT,EAA5B,CAAP;AACD","sourcesContent":["import debug from \"debug\";\nimport { addResizeObserver } from \"../add-resize-observer\";\nimport { Audioset } from \"../audioset\";\nimport { Visuals } from \"../visuals\";\nimport { ControlCommand } from \"./Control\";\nimport { Effects } from \"./Control\";\n\nconst log = debug(\"atpls:visuals\");\n\nexport function createVisualEffects(audioset: Audioset): Effects {\n  return new VisualEffects(audioset);\n}\n\nclass VisualEffects implements Effects {\n  private visuals?: Visuals;\n  constructor(readonly audioset: Audioset) {}\n\n  public attach(el: any): void {\n    this.detach();\n    this.visuals = new Visuals(this.audioset, el);\n    setupVisuals(this.audioset, this.visuals);\n    const resize = (width: number, height: number) => {\n      if (this.visuals) {\n        this.visuals.resizeSvg(width, height);\n      }\n    };\n    this.detach = addResizeObserver(el, resize);\n  }\n  public detach(): void {\n    // Attach replaces this method\n  }\n  public run(command: ControlCommand): void {\n    if (this.visuals) {\n      switch (command.command) {\n        case \"startClip\":\n          return this.visuals.show(command.clipId);\n        case \"stopClip\":\n          return this.visuals.hide(command.clipId);\n      }\n    }\n  }\n}\n\n// TODO: this should be part of resource loader\nfunction setupVisuals(audioset: Audioset, visuals: Visuals): Promise<Visuals> {\n  if (audioset.visuals.mode === \"map\") {\n    // TODO: remove it when found a solution for mobile / desktop\n    return fetchGeomap(audioset.visuals.geomap.url)\n      .then((data: object) => visuals.setGeodata(data))\n      .then(() => visuals);\n  } else {\n    visuals.setup();\n    return Promise.resolve(visuals);\n  }\n}\n\nfunction fetchGeomap(url: string): Promise<object> {\n  log(\"Geomap url %s\", url);\n\n  return fetch(url).then(response => response.json());\n}\n"]},"metadata":{},"sourceType":"module"}