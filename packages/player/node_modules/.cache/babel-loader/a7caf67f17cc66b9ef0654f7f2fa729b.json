{"ast":null,"code":"import debug from \"debug\";\nimport { AudioContext } from \"standardized-audio-context\";\nconst log = debug(\"atpls:context\");\nconst activeListeners = [];\nconst context = new AudioContext();\ncontext.onstatechange = handleStateChange;\nhandleStateChange();\n\nfunction handleStateChange() {\n  const state = context.state;\n  log(\"state %s\", state);\n\n  if (state === \"running\") {\n    const listeners = activeListeners.slice();\n    activeListeners.length = 0;\n  }\n}\n/**\n * @see https://developers.google.com/web/updates/2017/09/autoplay-policy-changes#webaudio\n */\n\n\nexport function getActiveAudioContext() {\n  if (context.state === \"running\") {\n    return Promise.resolve(context);\n  } else {\n    return new Promise(resolve => {\n      activeListeners.push(resolve);\n    });\n  }\n}\n\nfunction startAudioContext(ctx) {\n  log(\"start context\"); // iOS hack. See https://github.com/tambien/StartAudioContext/blob/master/StartAudioContext.js\n\n  const buffer = ctx.createBuffer(1, 1, ctx.sampleRate);\n  const source = ctx.createBufferSource();\n  source.buffer = buffer;\n  source.connect(ctx.destination);\n  source.start(0);\n  return ctx;\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/AudioContext.ts"],"names":["debug","AudioContext","log","activeListeners","context","onstatechange","handleStateChange","state","listeners","slice","length","getActiveAudioContext","Promise","resolve","push","startAudioContext","ctx","buffer","createBuffer","sampleRate","source","createBufferSource","connect","destination","start"],"mappings":"AACA,OAAOA,KAAP,MAAkB,OAAlB;AACA,SAASC,YAAT,QAA6B,4BAA7B;AAEA,MAAMC,GAAG,GAAGF,KAAK,CAAC,eAAD,CAAjB;AAGA,MAAMG,eAAiC,GAAG,EAA1C;AACA,MAAMC,OAAO,GAAG,IAAIH,YAAJ,EAAhB;AACAG,OAAO,CAACC,aAAR,GAAwBC,iBAAxB;AAEAA,iBAAiB;;AAEjB,SAASA,iBAAT,GAA6B;AAC3B,QAAMC,KAAK,GAAGH,OAAO,CAACG,KAAtB;AACAL,EAAAA,GAAG,CAAC,UAAD,EAAaK,KAAb,CAAH;;AACA,MAAIA,KAAK,KAAK,SAAd,EAAyB;AACvB,UAAMC,SAAS,GAAGL,eAAe,CAACM,KAAhB,EAAlB;AACAN,IAAAA,eAAe,CAACO,MAAhB,GAAyB,CAAzB;AACD;AACF;AAED;;;;;AAGA,OAAO,SAASC,qBAAT,GAAwD;AAC7D,MAAIP,OAAO,CAACG,KAAR,KAAkB,SAAtB,EAAiC;AAC/B,WAAOK,OAAO,CAACC,OAAR,CAAgBT,OAAhB,CAAP;AACD,GAFD,MAEO;AACL,WAAO,IAAIQ,OAAJ,CAA0BC,OAAO,IAAI;AAC1CV,MAAAA,eAAe,CAACW,IAAhB,CAAqBD,OAArB;AACD,KAFM,CAAP;AAGD;AACF;;AAED,SAASE,iBAAT,CAA2BC,GAA3B,EAA4D;AAC1Dd,EAAAA,GAAG,CAAC,eAAD,CAAH,CAD0D,CAE1D;;AACA,QAAMe,MAAM,GAAGD,GAAG,CAACE,YAAJ,CAAiB,CAAjB,EAAoB,CAApB,EAAuBF,GAAG,CAACG,UAA3B,CAAf;AACA,QAAMC,MAAM,GAAGJ,GAAG,CAACK,kBAAJ,EAAf;AACAD,EAAAA,MAAM,CAACH,MAAP,GAAgBA,MAAhB;AACAG,EAAAA,MAAM,CAACE,OAAP,CAAeN,GAAG,CAACO,WAAnB;AACAH,EAAAA,MAAM,CAACI,KAAP,CAAa,CAAb;AACA,SAAOR,GAAP;AACD","sourcesContent":["import { active } from \"d3\";\nimport debug from \"debug\";\nimport { AudioContext } from \"standardized-audio-context\";\n\nconst log = debug(\"atpls:context\");\n\ntype ResolveContext = (value: AudioContext) => void;\nconst activeListeners: ResolveContext[] = [];\nconst context = new AudioContext();\ncontext.onstatechange = handleStateChange;\n\nhandleStateChange();\n\nfunction handleStateChange() {\n  const state = context.state;\n  log(\"state %s\", state);\n  if (state === \"running\") {\n    const listeners = activeListeners.slice();\n    activeListeners.length = 0;\n  }\n}\n\n/**\n * @see https://developers.google.com/web/updates/2017/09/autoplay-policy-changes#webaudio\n */\nexport function getActiveAudioContext(): Promise<AudioContext> {\n  if (context.state === \"running\") {\n    return Promise.resolve(context);\n  } else {\n    return new Promise<AudioContext>(resolve => {\n      activeListeners.push(resolve);\n    });\n  }\n}\n\nfunction startAudioContext(ctx: AudioContext): AudioContext {\n  log(\"start context\");\n  // iOS hack. See https://github.com/tambien/StartAudioContext/blob/master/StartAudioContext.js\n  const buffer = ctx.createBuffer(1, 1, ctx.sampleRate);\n  const source = ctx.createBufferSource();\n  source.buffer = buffer;\n  source.connect(ctx.destination);\n  source.start(0);\n  return ctx;\n}\n"]},"metadata":{},"sourceType":"module"}