{"ast":null,"code":"import _slicedToArray from \"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport { getAlbumHeight } from \"./dimensions\";\nimport drawCircle from \"./drawCircle\";\nimport drawAlbum from \"./drawAlbum\";\nimport drawRefLine from \"./drawRefLine\";\nimport drawWave from \"./drawWave\";\nimport { drawMap, calculateMapScale, createMapProjector } from \"./drawMap\";\nimport { drawPanel, createPanelProjector } from \"./drawPanel\";\n\nconst remove = (clipId, group) => {\n  const value = group[clipId];\n\n  if (value) {\n    value.remove();\n    group[clipId] = null;\n  }\n};\n\nfunction createProjector(visuals, dimension) {\n  const width = dimension.width,\n        height = dimension.height;\n  const albumsHeight = getAlbumHeight(width);\n  const scale = calculateMapScale(width, height - albumsHeight);\n  return visuals.mode === \"map\" ? createMapProjector(dimension.width, dimension.height - albumsHeight, visuals.geomap.scaleFactor * scale, visuals.geomap.center) : createPanelProjector(dimension.width, dimension.height - albumsHeight, visuals.image.size.width, visuals.image.size.height);\n}\n\n/**\n * It stores the state required to render visualizations\n */\nexport class Visuals {\n  constructor(set, display) {\n    this.set = set;\n    this.display = display;\n    this.circles = {};\n    this.albums = {};\n    this.refLines = {};\n    this.countries = void 0;\n    this.visuals = void 0;\n    this.backgroundContainer = void 0;\n    this.albumsContainer = void 0;\n    this.refLinesContainer = void 0;\n    this.circlesContainer = void 0;\n    this.wavesContainer = void 0;\n    this.projector = void 0;\n    this.visuals = set.visuals;\n  }\n\n  setCountries(countries) {\n    this.countries = countries;\n    this.setup();\n  }\n\n  show(clipId) {\n    const clip = this.set.index.clipById[clipId];\n    if (!clip) return; // REVIEW: See if there is a better way to get this info (scale, projection)\n    // that is already calculated in drawMap\n\n    const width = this.display.dimensions.width;\n\n    const _this$projector = this.projector(clip.position),\n          _this$projector2 = _slicedToArray(_this$projector, 2),\n          cx = _this$projector2[0],\n          cy = _this$projector2[1]; // REVIEW: fix width parameter to draw circles with the proper size\n\n\n    const circle = drawCircle(this.circlesContainer, width, cx, cy, clip);\n    this.circles[clipId] = circle;\n    const album = drawAlbum(this.albumsContainer, width, clip);\n    this.albums[clipId] = album;\n    const refLine = drawRefLine(this.refLinesContainer, width, cx, cy, clip);\n    this.refLines[clipId] = refLine;\n    drawWave(this.wavesContainer, width, cx, cy, clip);\n  }\n\n  hide(clipId) {\n    remove(clipId, this.circles);\n    remove(clipId, this.albums);\n    remove(clipId, this.refLines);\n  }\n\n  resizeSvg() {\n    // TODO: create a resize function that only changes the svg viewBox\n    this.setup();\n  }\n\n  setup() {\n    this.display.clear();\n    this.display.createSvg();\n    this.projector = createProjector(this.visuals, this.display.dimensions);\n    const backgroundWidth = this.display.dimensions.width;\n    const albumsHeight = getAlbumHeight(backgroundWidth);\n    const backgroundHeight = this.display.dimensions.height - albumsHeight;\n    this.backgroundContainer = this.createGroup(\"background\", albumsHeight);\n    this.albumsContainer = this.createGroup(\"albums\", 0);\n    this.refLinesContainer = this.createGroup(\"refLines\", albumsHeight);\n    this.circlesContainer = this.createGroup(\"circles\", albumsHeight);\n    this.wavesContainer = this.createGroup(\"waves\", albumsHeight);\n\n    if (this.visuals.mode === \"map\") {\n      drawMap(this.backgroundContainer, this.countries, backgroundWidth, backgroundHeight, this.visuals.geomap);\n    } else {\n      drawPanel(this.backgroundContainer, backgroundWidth, backgroundHeight, this.visuals.image.url);\n    }\n  }\n\n  createGroup(id, height) {\n    const svg = this.display.svg;\n    return svg.append(\"g\").attr(\"id\", id).attr(\"transform\", \"translate(0, \".concat(height, \")\"));\n  }\n\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/visuals/visuals.ts"],"names":["getAlbumHeight","drawCircle","drawAlbum","drawRefLine","drawWave","drawMap","calculateMapScale","createMapProjector","drawPanel","createPanelProjector","remove","clipId","group","value","createProjector","visuals","dimension","width","height","albumsHeight","scale","mode","geomap","scaleFactor","center","image","size","Visuals","constructor","set","display","circles","albums","refLines","countries","backgroundContainer","albumsContainer","refLinesContainer","circlesContainer","wavesContainer","projector","setCountries","setup","show","clip","index","clipById","dimensions","position","cx","cy","circle","album","refLine","hide","resizeSvg","clear","createSvg","backgroundWidth","backgroundHeight","createGroup","url","id","svg","append","attr"],"mappings":"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","sourcesContent":["\nimport { getAlbumHeight } from \"./dimensions\";\n\nimport drawCircle from \"./drawCircle\";\nimport drawAlbum from \"./drawAlbum\";\nimport drawRefLine, { RefLine } from \"./drawRefLine\";\nimport drawWave from \"./drawWave\";\nimport { drawMap, calculateMapScale, createMapProjector } from \"./drawMap\";\nimport { drawPanel, createPanelProjector } from \"./drawPanel\";\nimport { Audioset, AudiosetVisuals } from \"../Audioset\";\nimport { Display, Dimension } from \"./display\";\nimport { Selection } from \"d3\";\n\nconst remove = (clipId: string, group: Record<string, any>) => {\n  const value = group[clipId];\n  if (value) {\n    value.remove();\n    group[clipId] = null;\n  }\n};\nfunction createProjector(visuals: AudiosetVisuals, dimension: Dimension) {\n  const { width, height } = dimension;\n  const albumsHeight = getAlbumHeight(width);\n\n  const scale = calculateMapScale(width, height - albumsHeight);\n  return visuals.mode === \"map\"\n    ? createMapProjector(\n        dimension.width,\n        dimension.height - albumsHeight,\n        visuals.geomap.scaleFactor * scale,\n        visuals.geomap.center,\n      )\n    : createPanelProjector(\n        dimension.width,\n        dimension.height - albumsHeight,\n        visuals.image.size.width,\n        visuals.image.size.height,\n      );\n}\n\nexport type D3Selection = Selection<SVGGElement, unknown, null, undefined>;\n\n/**\n * It stores the state required to render visualizations\n */\nexport class Visuals {\n  circles: Record<string, D3Selection> = {};\n  albums: Record<string, D3Selection> = {};\n  refLines: Record<string, RefLine> = {};\n  countries: any;\n  visuals: AudiosetVisuals;\n  private backgroundContainer!: D3Selection;\n  private albumsContainer!: D3Selection;\n  private refLinesContainer!: D3Selection;\n  private circlesContainer!: D3Selection;\n  private wavesContainer!: D3Selection;\n  projector: any;\n\n  constructor(private set: Audioset, private display: Display) {\n    this.visuals = set.visuals;\n  }\n\n  setCountries(countries: any) {\n    this.countries = countries\n    this.setup();\n  }\n\n  show(clipId: string) {\n    const clip = this.set.index.clipById[clipId];\n    if (!clip) return;\n\n    // REVIEW: See if there is a better way to get this info (scale, projection)\n    // that is already calculated in drawMap\n    const { width } = this.display.dimensions;\n\n\n    const [cx, cy] = this.projector(clip.position);\n\n    // REVIEW: fix width parameter to draw circles with the proper size\n    const circle = drawCircle(this.circlesContainer, width, cx, cy, clip);\n    this.circles[clipId] = circle;\n\n    const album = drawAlbum(this.albumsContainer, width, clip);\n    this.albums[clipId] = album;\n\n    const refLine = drawRefLine(this.refLinesContainer, width, cx, cy, clip);\n    this.refLines[clipId] = refLine;\n\n    drawWave(this.wavesContainer, width, cx, cy, clip);\n  }\n\n  public hide(clipId: string) {\n    remove(clipId, this.circles);\n    remove(clipId, this.albums);\n    remove(clipId, this.refLines);\n  }\n\n  public resizeSvg() {\n    // TODO: create a resize function that only changes the svg viewBox\n    this.setup();\n  }\n\n  setup() {\n    this.display.clear();\n    this.display.createSvg();\n    this.projector = createProjector(this.visuals, this.display.dimensions);\n\n    const backgroundWidth = this.display.dimensions.width;\n    const albumsHeight = getAlbumHeight(backgroundWidth);\n    const backgroundHeight = this.display.dimensions.height - albumsHeight;\n\n    this.backgroundContainer = this.createGroup(\"background\", albumsHeight);\n    this.albumsContainer = this.createGroup(\"albums\", 0);\n    this.refLinesContainer = this.createGroup(\"refLines\", albumsHeight);\n    this.circlesContainer = this.createGroup(\"circles\", albumsHeight);\n    this.wavesContainer = this.createGroup(\"waves\", albumsHeight);\n\n    if (this.visuals.mode === \"map\") {\n      drawMap(this.backgroundContainer, this.countries, backgroundWidth, backgroundHeight, this.visuals.geomap);\n    } else {\n      drawPanel(this.backgroundContainer, backgroundWidth, backgroundHeight, this.visuals.image.url);\n    }\n  }\n  private createGroup(id: string, height: number): D3Selection {\n    const svg = this.display.svg;\n    return svg.append(\"g\").attr(\"id\", id).attr(\"transform\", `translate(0, ${height})`);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}