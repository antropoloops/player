{"ast":null,"code":"import debug from \"debug\";\nimport { TimeManager } from \"../TimeManager\";\nimport { ControlStateManager } from \"./ControlStateManager\";\nimport { KeyboardControler } from \"./KeyboardControler\";\nconst log = debug(\"atpls:control\");\n\nclass ControlEvents {\n  constructor(listener) {\n    this.listener = listener;\n    this.commands = [];\n  }\n\n}\n/**\n * Controls the playing state of clips and tracks\n *\n * It uses a listener for side effects (using commands) and state changees\n */\n\n\nexport class AudiosetControl {\n  constructor(audioset, listener) {\n    this.keyboard = void 0;\n    this.time = void 0;\n    this.manager = new ControlStateManager();\n    this.commands = void 0;\n    log(\"create control\");\n    this.time = new TimeManager(audioset.audio);\n    this.keyboard = new KeyboardControler(audioset, this);\n    this.commands = new ControlEvents(listener);\n    audioset.clips.forEach(clip => this.manager.addClip(clip));\n    audioset.tracks.forEach(track => this.manager.addTrack(track));\n  }\n\n  toggleClip(clipId, time) {\n    const clipState = this.manager.getClipState(clipId);\n\n    if (!clipState) {\n      return;\n    } else if (clipState.state === \"stopped\") {\n      this.startClip(clipId, time);\n    } else if (clipState.state === \"playing\") {\n      this.stopClip(clipId, time);\n    }\n  }\n  /**\n   * Start a clip\n   * @param clipId\n   */\n\n\n  startClip(clipId, time) {\n    const clipState = this.manager.getClipState(clipId);\n\n    if (!clipState || clipState.state === \"playing\") {\n      return;\n    }\n\n    time = this.time.startTime(time);\n    log(\"start clip %s %o\", clipId, time);\n    const trackId = this.manager.getTrackIdOfClip(clipId);\n    const sameTrackClipIds = this.manager.getClipIdsOfTrack(trackId);\n    sameTrackClipIds.forEach(trackClipId => this.stopClipCommand(trackClipId, time));\n    this.startTrackCommand(trackId, time);\n    this.startClipCommand(clipId, time);\n    this.sendCommandsAndFireStateChange();\n  }\n  /**\n   * Stops a clip\n   */\n\n\n  stopClip(clipId, time) {\n    const clipState = this.manager.getClipState(clipId);\n\n    if (!clipState || clipState.state === \"stopped\") {\n      return;\n    }\n\n    time = this.time.stopTime(time);\n    log(\"stop clip %s %o\", clipId, time);\n    const trackId = this.manager.getTrackIdOfClip(clipId);\n    this.stopClipCommand(clipId, time);\n    this.stopTrackCommand(trackId, time);\n    this.sendCommandsAndFireStateChange();\n  }\n  /**\n   * Stops all clips\n   */\n\n\n  stopAll(time) {\n    this.manager.getAllClipIds().forEach(clipId => this.stopClipCommand(clipId, time));\n    this.manager.getAllTrackIds().forEach(trackId => this.stopTrackCommand(trackId, time));\n    this.sendCommandsAndFireStateChange();\n  }\n\n  getState() {\n    return this.manager.getState();\n  } //// PRIVATE ////\n\n\n  sendCommandsAndFireStateChange() {\n    this.commands.forEach(command => {\n      this.listener.onControlCommand(command);\n    });\n    this.commands = [];\n    this.listener.onControlStateChanged(this.getState());\n  }\n\n  startClipCommand(clipId, time) {\n    const clipState = this.manager.getClipState(clipId);\n\n    if (clipState.state === \"playing\") {\n      return;\n    }\n\n    this.manager.setClipState(clipId, {\n      state: \"playing\"\n    });\n    this.commands.push({\n      command: \"startClip\",\n      clipId,\n      time\n    });\n  }\n\n  stopClipCommand(clipId, time) {\n    const clipState = this.manager.getClipState(clipId);\n\n    if (clipState.state === \"stopped\") {\n      return;\n    }\n\n    this.manager.setClipState(clipId, {\n      state: \"stopped\"\n    });\n    this.commands.push({\n      command: \"stopClip\",\n      clipId,\n      time\n    });\n  }\n\n  startTrackCommand(trackId, time) {\n    const trackState = this.manager.getTrackState(trackId);\n\n    if (trackState.state === \"playing\") {\n      return;\n    }\n\n    this.manager.setTrackState(trackId, {\n      state: \"playing\",\n      volume: trackState.volume\n    });\n    this.commands.push({\n      command: \"startTrack\",\n      trackId,\n      time\n    });\n  }\n\n  stopTrackCommand(trackId, time) {\n    const trackState = this.manager.getTrackState(trackId);\n\n    if (trackState.state === \"stopped\") {\n      return;\n    }\n\n    this.manager.setTrackState(trackId, {\n      state: \"stopped\",\n      volume: trackState.volume\n    });\n    this.commands.push({\n      command: \"stopTrack\",\n      trackId,\n      time\n    });\n  }\n\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/Control/AudiosetControl.ts"],"names":["debug","TimeManager","ControlStateManager","KeyboardControler","log","ControlEvents","constructor","listener","commands","AudiosetControl","audioset","keyboard","time","manager","audio","clips","forEach","clip","addClip","tracks","track","addTrack","toggleClip","clipId","clipState","getClipState","state","startClip","stopClip","startTime","trackId","getTrackIdOfClip","sameTrackClipIds","getClipIdsOfTrack","trackClipId","stopClipCommand","startTrackCommand","startClipCommand","sendCommandsAndFireStateChange","stopTime","stopTrackCommand","stopAll","getAllClipIds","getAllTrackIds","getState","command","onControlCommand","onControlStateChanged","setClipState","push","trackState","getTrackState","setTrackState","volume"],"mappings":"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","sourcesContent":["import debug from \"debug\";\nimport { Audioset, Clip } from \"../../audioset\";\nimport { TimeManager } from \"../TimeManager\";\nimport { ControlCommand } from \"./ControlCommand\";\nimport { ControlState } from \"./ControlState\";\nimport { ControlStateManager } from \"./ControlStateManager\";\nimport { KeyboardControler } from \"./KeyboardControler\";\n\nconst log = debug(\"atpls:control\");\n\nexport interface ControlListener {\n  onControlStateChanged: (state: ControlState) => void;\n  onControlCommand: (command: ControlCommand) => void;\n}\n\nexport interface PlayerControl {\n  readonly keyboard: KeyboardControler;\n  getState(): ControlState;\n  toggleClip(clipId: string, time: number): void;\n  stopClip(clipId: string, time: number): void;\n  startClip(clipId: string, time: number): void;\n  stopAll(time: number): void;\n}\n\nclass ControlEvents {\n  private commands: ControlCommand[] = [];\n\n  constructor(private listener: ControlListener) {}\n}\n\n/**\n * Controls the playing state of clips and tracks\n *\n * It uses a listener for side effects (using commands) and state changees\n */\nexport class AudiosetControl implements PlayerControl {\n  public readonly keyboard: KeyboardControler;\n  private time: TimeManager;\n  private manager = new ControlStateManager();\n  private commands: ControlEvents;\n\n  constructor(audioset: Audioset, listener: ControlListener) {\n    log(\"create control\");\n    this.time = new TimeManager(audioset.audio);\n    this.keyboard = new KeyboardControler(audioset, this);\n    this.commands = new ControlEvents(listener);\n    audioset.clips.forEach((clip: Clip) => this.manager.addClip(clip));\n    audioset.tracks.forEach(track => this.manager.addTrack(track));\n  }\n\n  public toggleClip(clipId: string, time: number) {\n    const clipState = this.manager.getClipState(clipId);\n    if (!clipState) {\n      return;\n    } else if (clipState.state === \"stopped\") {\n      this.startClip(clipId, time);\n    } else if (clipState.state === \"playing\") {\n      this.stopClip(clipId, time);\n    }\n  }\n\n  /**\n   * Start a clip\n   * @param clipId\n   */\n  public startClip(clipId: string, time: number) {\n    const clipState = this.manager.getClipState(clipId);\n    if (!clipState || clipState.state === \"playing\") {\n      return;\n    }\n\n    time = this.time.startTime(time);\n    log(\"start clip %s %o\", clipId, time);\n\n    const trackId = this.manager.getTrackIdOfClip(clipId);\n    const sameTrackClipIds = this.manager.getClipIdsOfTrack(trackId);\n    sameTrackClipIds.forEach(trackClipId =>\n      this.stopClipCommand(trackClipId, time),\n    );\n    this.startTrackCommand(trackId, time);\n    this.startClipCommand(clipId, time);\n    this.sendCommandsAndFireStateChange();\n  }\n\n  /**\n   * Stops a clip\n   */\n  public stopClip(clipId: string, time: number) {\n    const clipState = this.manager.getClipState(clipId);\n    if (!clipState || clipState.state === \"stopped\") {\n      return;\n    }\n\n    time = this.time.stopTime(time);\n    log(\"stop clip %s %o\", clipId, time);\n\n    const trackId = this.manager.getTrackIdOfClip(clipId);\n\n    this.stopClipCommand(clipId, time);\n    this.stopTrackCommand(trackId, time);\n    this.sendCommandsAndFireStateChange();\n  }\n\n  /**\n   * Stops all clips\n   */\n  public stopAll(time: number) {\n    this.manager\n      .getAllClipIds()\n      .forEach(clipId => this.stopClipCommand(clipId, time));\n    this.manager\n      .getAllTrackIds()\n      .forEach(trackId => this.stopTrackCommand(trackId, time));\n    this.sendCommandsAndFireStateChange();\n  }\n\n  public getState() {\n    return this.manager.getState();\n  }\n\n  //// PRIVATE ////\n  private sendCommandsAndFireStateChange() {\n    this.commands.forEach(command => {\n      this.listener.onControlCommand(command);\n    });\n    this.commands = [];\n\n    this.listener.onControlStateChanged(this.getState());\n  }\n\n  private startClipCommand(clipId: string, time: number) {\n    const clipState = this.manager.getClipState(clipId);\n    if (clipState.state === \"playing\") {\n      return;\n    }\n\n    this.manager.setClipState(clipId, { state: \"playing\" });\n    this.commands.push({ command: \"startClip\", clipId, time });\n  }\n\n  private stopClipCommand(clipId: string, time: number) {\n    const clipState = this.manager.getClipState(clipId);\n    if (clipState.state === \"stopped\") {\n      return;\n    }\n\n    this.manager.setClipState(clipId, { state: \"stopped\" });\n    this.commands.push({ command: \"stopClip\", clipId, time });\n  }\n\n  private startTrackCommand(trackId: string, time: number) {\n    const trackState = this.manager.getTrackState(trackId);\n    if (trackState.state === \"playing\") {\n      return;\n    }\n\n    this.manager.setTrackState(trackId, {\n      state: \"playing\",\n      volume: trackState.volume,\n    });\n    this.commands.push({ command: \"startTrack\", trackId, time });\n  }\n\n  private stopTrackCommand(trackId: string, time: number) {\n    const trackState = this.manager.getTrackState(trackId);\n    if (trackState.state === \"stopped\") {\n      return;\n    }\n\n    this.manager.setTrackState(trackId, {\n      state: \"stopped\",\n      volume: trackState.volume,\n    });\n    this.commands.push({ command: \"stopTrack\", trackId, time });\n  }\n}\n"]},"metadata":{},"sourceType":"module"}