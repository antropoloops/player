{"ast":null,"code":"import debug from\"debug\";import{AudioContext}from\"standardized-audio-context\";import unmute from\"./unmute\";var log=debug(\"atpls:context\");var activeListeners=[];var context=new AudioContext();context.onstatechange=handleStateChange;/**\n * Waits until the AudioContext is in \"running\" state\n *\n * @see https://developers.google.com/web/updates/2017/09/autoplay-policy-changes#webaudio\n */export function getActiveAudioContext(){if(context.state===\"running\"){return Promise.resolve(context);}else{return new Promise(function(resolve){activeListeners.push(resolve);});}}export function autoUnlockAudio(){function unlock(){unmute(context);var prevHandler=context.onstatechange;// FIXME: think better how to fix this\ncontext.onstatechange=function(args){handleStateChange();if(prevHandler){prevHandler(args);}};context.resume().then(detach);}function detach(){// Remove the touch start listener.\nlog(\"detach auto unlock\",context.state);document.removeEventListener(\"touchstart\",unlock,true);document.removeEventListener(\"touchend\",unlock,true);document.removeEventListener(\"click\",unlock,true);}// Setup a touch start listener to attempt an unlock in.\nlog(\"attach auto unlock\");document.addEventListener(\"touchstart\",unlock,true);document.addEventListener(\"touchend\",unlock,true);document.addEventListener(\"click\",unlock,true);}function handleStateChange(){var state=context.state;log(\"state %s\",state);if(state===\"running\"){var listeners=activeListeners.slice();activeListeners.length=0;listeners.forEach(function(listener){return listener(context);});}}handleStateChange();","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/packages/player/src/active-audio-context/index.ts"],"names":["debug","AudioContext","unmute","log","activeListeners","context","onstatechange","handleStateChange","getActiveAudioContext","state","Promise","resolve","push","autoUnlockAudio","unlock","prevHandler","args","resume","then","detach","document","removeEventListener","addEventListener","listeners","slice","length","forEach","listener"],"mappings":"AAAA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CACA,OAASC,YAAT,KAA6B,4BAA7B,CACA,MAAOC,CAAAA,MAAP,KAAmB,UAAnB,CAEA,GAAMC,CAAAA,GAAG,CAAGH,KAAK,CAAC,eAAD,CAAjB,CAGA,GAAMI,CAAAA,eAAiC,CAAG,EAA1C,CACA,GAAMC,CAAAA,OAAO,CAAG,GAAIJ,CAAAA,YAAJ,EAAhB,CACAI,OAAO,CAACC,aAAR,CAAwBC,iBAAxB,CAEA;;;;GAKA,MAAO,SAASC,CAAAA,qBAAT,EAAwD,CAC7D,GAAIH,OAAO,CAACI,KAAR,GAAkB,SAAtB,CAAiC,CAC/B,MAAOC,CAAAA,OAAO,CAACC,OAAR,CAAgBN,OAAhB,CAAP,CACD,CAFD,IAEO,CACL,MAAO,IAAIK,CAAAA,OAAJ,CAA0B,SAACC,OAAD,CAAa,CAC5CP,eAAe,CAACQ,IAAhB,CAAqBD,OAArB,EACD,CAFM,CAAP,CAGD,CACF,CAED,MAAO,SAASE,CAAAA,eAAT,EAA2B,CAChC,QAASC,CAAAA,MAAT,EAAkB,CAChBZ,MAAM,CAACG,OAAD,CAAN,CACA,GAAMU,CAAAA,WAAW,CAAGV,OAAO,CAACC,aAA5B,CACA;AACAD,OAAO,CAACC,aAAR,CAAwB,SAACU,IAAD,CAAU,CAChCT,iBAAiB,GACjB,GAAIQ,WAAJ,CAAiB,CACfA,WAAW,CAACC,IAAD,CAAX,CACD,CACF,CALD,CAMAX,OAAO,CAACY,MAAR,GAAiBC,IAAjB,CAAsBC,MAAtB,EACD,CAED,QAASA,CAAAA,MAAT,EAAkB,CAChB;AACAhB,GAAG,CAAC,oBAAD,CAAuBE,OAAO,CAACI,KAA/B,CAAH,CACAW,QAAQ,CAACC,mBAAT,CAA6B,YAA7B,CAA2CP,MAA3C,CAAmD,IAAnD,EACAM,QAAQ,CAACC,mBAAT,CAA6B,UAA7B,CAAyCP,MAAzC,CAAiD,IAAjD,EACAM,QAAQ,CAACC,mBAAT,CAA6B,OAA7B,CAAsCP,MAAtC,CAA8C,IAA9C,EACD,CAED;AACAX,GAAG,CAAC,oBAAD,CAAH,CACAiB,QAAQ,CAACE,gBAAT,CAA0B,YAA1B,CAAwCR,MAAxC,CAAgD,IAAhD,EACAM,QAAQ,CAACE,gBAAT,CAA0B,UAA1B,CAAsCR,MAAtC,CAA8C,IAA9C,EACAM,QAAQ,CAACE,gBAAT,CAA0B,OAA1B,CAAmCR,MAAnC,CAA2C,IAA3C,EACD,CAED,QAASP,CAAAA,iBAAT,EAA6B,CAC3B,GAAME,CAAAA,KAAK,CAAGJ,OAAO,CAACI,KAAtB,CACAN,GAAG,CAAC,UAAD,CAAaM,KAAb,CAAH,CACA,GAAIA,KAAK,GAAK,SAAd,CAAyB,CACvB,GAAMc,CAAAA,SAAS,CAAGnB,eAAe,CAACoB,KAAhB,EAAlB,CACApB,eAAe,CAACqB,MAAhB,CAAyB,CAAzB,CACAF,SAAS,CAACG,OAAV,CAAkB,SAACC,QAAD,QAAcA,CAAAA,QAAQ,CAACtB,OAAD,CAAtB,EAAlB,EACD,CACF,CAEDE,iBAAiB","sourcesContent":["import debug from \"debug\";\nimport { AudioContext } from \"standardized-audio-context\";\nimport unmute from \"./unmute\";\n\nconst log = debug(\"atpls:context\");\n\ntype ResolveContext = (value: AudioContext) => void;\nconst activeListeners: ResolveContext[] = [];\nconst context = new AudioContext();\ncontext.onstatechange = handleStateChange;\n\n/**\n * Waits until the AudioContext is in \"running\" state\n *\n * @see https://developers.google.com/web/updates/2017/09/autoplay-policy-changes#webaudio\n */\nexport function getActiveAudioContext(): Promise<AudioContext> {\n  if (context.state === \"running\") {\n    return Promise.resolve(context);\n  } else {\n    return new Promise<AudioContext>((resolve) => {\n      activeListeners.push(resolve);\n    });\n  }\n}\n\nexport function autoUnlockAudio() {\n  function unlock() {\n    unmute(context);\n    const prevHandler = context.onstatechange;\n    // FIXME: think better how to fix this\n    context.onstatechange = (args) => {\n      handleStateChange();\n      if (prevHandler) {\n        prevHandler(args);\n      }\n    };\n    context.resume().then(detach);\n  }\n\n  function detach() {\n    // Remove the touch start listener.\n    log(\"detach auto unlock\", context.state);\n    document.removeEventListener(\"touchstart\", unlock, true);\n    document.removeEventListener(\"touchend\", unlock, true);\n    document.removeEventListener(\"click\", unlock, true);\n  }\n\n  // Setup a touch start listener to attempt an unlock in.\n  log(\"attach auto unlock\");\n  document.addEventListener(\"touchstart\", unlock, true);\n  document.addEventListener(\"touchend\", unlock, true);\n  document.addEventListener(\"click\", unlock, true);\n}\n\nfunction handleStateChange() {\n  const state = context.state;\n  log(\"state %s\", state);\n  if (state === \"running\") {\n    const listeners = activeListeners.slice();\n    activeListeners.length = 0;\n    listeners.forEach((listener) => listener(context));\n  }\n}\n\nhandleStateChange();\n"]},"metadata":{},"sourceType":"module"}