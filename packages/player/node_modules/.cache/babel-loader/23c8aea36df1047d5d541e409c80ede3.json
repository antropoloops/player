{"ast":null,"code":"import _classCallCheck from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import{EmptyAudioset}from\"../Audioset\";import{AudiosetLoader}from\"../Audioset/AudiosetLoader\";import{DebugAudioEngine}from\"./Audio\";import{AudiosetControl}from\"./AudiosetControl\";import{ResourceLoader}from\"./ResourceLoader\";import{Sampler}from\"./Sampler\";var Emitter=/*#__PURE__*/function(){function Emitter(){_classCallCheck(this,Emitter);this.listeners=[];}_createClass(Emitter,[{key:\"emit\",value:function emit(event){this.listeners.forEach(function(listen){return listen(event);});}},{key:\"on\",value:function on(listener){var _this=this;this.listeners.push(listener);return function(){return _this.off(listener);};}},{key:\"off\",value:function off(listener){var index=this.listeners.indexOf(listener);if(index>-1){this.listeners.splice(index,1);}}}]);return Emitter;}();/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */export var Player=/*#__PURE__*/function(){function Player(){var _this2=this;_classCallCheck(this,Player);this.loader=void 0;this.control=void 0;this.resources=void 0;this.sampler=void 0;this.noSampler=void 0;this.noControl=void 0;this.noResources=void 0;this.controlListener=void 0;this.resourceListener=void 0;this.audiosetChanged=new Emitter();this.audiosetLoadStatusChanged=new Emitter();this.controlStateChanged=new Emitter();this.controlCommand=new Emitter();this.resourceStatusChanged=new Emitter();this.fetchAudio=void 0;this.audio=new DebugAudioEngine();this.audioset=EmptyAudioset;this.loader=new AudiosetLoader(function(status){return _this2.setAudiosetLoadStatus(status);});this.controlListener={onControlStateChanged:function onControlStateChanged(state){return _this2.emitControlState(state);},onControlCommand:function onControlCommand(command){return _this2.runCommand(command);}};this.resourceListener=function(status){_this2.resourceStatusChanged.emit(status);};this.noControl=this.control=new AudiosetControl(this.audioset,this.controlListener);this.noResources=this.resources=new ResourceLoader(this.audioset,this.resourceListener);this.noSampler=this.sampler=new Sampler(this.audioset,this.resources,this.audio);}_createClass(Player,[{key:\"setFetchAudio\",value:function setFetchAudio(fetch){this.fetchAudio=fetch;this.resources.fetch=fetch;}},{key:\"setAudioEngine\",value:function setAudioEngine(audio){this.audio=audio;// this.sampler.dispose()\nthis.sampler=new Sampler(this.audioset,this.resources,this.audio);}},{key:\"onResourceStatusChanged\",value:function onResourceStatusChanged(listener){return this.resourceStatusChanged.on(listener);}},{key:\"onControlStateChanged\",value:function onControlStateChanged(listener){return this.controlStateChanged.on(listener);}},{key:\"onCommand\",value:function onCommand(listener){return this.controlCommand.on(listener);}//// PRIVATE /////k\n// allow pub/sub of contro state\n},{key:\"emitControlState\",value:function emitControlState(controlState){this.controlStateChanged.emit(controlState);}// allows pub/sub of commands (for visuals)\n},{key:\"runCommand\",value:function runCommand(command){this.sampler.run(command);this.controlCommand.emit(command);}},{key:\"setAudiosetLoadStatus\",value:function setAudiosetLoadStatus(status){this.audiosetLoadStatusChanged.emit(status);if(status.status===\"ready\"){this.setDelegates(status.audioset);this.audiosetChanged.emit(status.audioset);}}},{key:\"setDelegates\",value:function setDelegates(audioset){if(isAudiosetPlay(audioset)){this.audioset=audioset;this.control=new AudiosetControl(audioset,this.controlListener);this.resources=new ResourceLoader(audioset,this.resourceListener);this.sampler=new Sampler(audioset,this.resources,this.audio);}else{this.control=this.noControl;this.sampler=this.noSampler;this.resources=this.noResources;}if(this.fetchAudio){this.resources.fetch=this.fetchAudio;}}}]);return Player;}();function isAudiosetPlay(audioset){return audioset.type===\"audioset\";}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/Player/Player.ts"],"names":["EmptyAudioset","AudiosetLoader","DebugAudioEngine","AudiosetControl","ResourceLoader","Sampler","Emitter","listeners","event","forEach","listen","listener","push","off","index","indexOf","splice","Player","loader","control","resources","sampler","noSampler","noControl","noResources","controlListener","resourceListener","audiosetChanged","audiosetLoadStatusChanged","controlStateChanged","controlCommand","resourceStatusChanged","fetchAudio","audio","audioset","status","setAudiosetLoadStatus","onControlStateChanged","state","emitControlState","onControlCommand","command","runCommand","emit","fetch","on","controlState","run","setDelegates","isAudiosetPlay","type"],"mappings":"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","sourcesContent":["import { Audioset, AudiosetData, EmptyAudioset } from \"../Audioset\";\nimport { AudiosetLoader, AudiosetLoadStatus } from \"../Audioset/AudiosetLoader\";\nimport { AudioEngine, DebugAudioEngine } from \"./Audio\";\nimport {\n  AudiosetControl,\n  ControlCommand,\n  ControlListener,\n  ControlState,\n} from \"./AudiosetControl\";\nimport {\n  FetchAudio,\n  ResourceLoader,\n  ResourceLoadStatus,\n} from \"./ResourceLoader\";\nimport { Sampler } from \"./Sampler\";\n\ntype Listener<T> = (event: T) => void;\nclass Emitter<T> {\n  private readonly listeners: Array<Listener<T>> = [];\n\n  public emit(event: T) {\n    this.listeners.forEach(listen => listen(event));\n  }\n\n  public on(listener: Listener<T>) {\n    this.listeners.push(listener);\n    return () => this.off(listener);\n  }\n\n  public off(listener: Listener<T>) {\n    const index = this.listeners.indexOf(listener);\n    if (index > -1) {\n      this.listeners.splice(index, 1);\n    }\n  }\n}\n\n/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */\nexport class Player {\n  public readonly loader: AudiosetLoader;\n  public control: AudiosetControl;\n  public resources: ResourceLoader;\n  private sampler: Sampler;\n\n  private noSampler: Sampler;\n  private noControl: AudiosetControl;\n  private noResources: ResourceLoader;\n\n  private readonly controlListener: ControlListener;\n  private readonly resourceListener: (status: ResourceLoadStatus) => void;\n\n  private readonly audiosetChanged = new Emitter<AudiosetData>();\n  private readonly audiosetLoadStatusChanged = new Emitter<\n    AudiosetLoadStatus\n  >();\n  private readonly controlStateChanged = new Emitter<ControlState>();\n  private readonly controlCommand = new Emitter<ControlCommand>();\n  private readonly resourceStatusChanged = new Emitter<ResourceLoadStatus>();\n\n  private fetchAudio?: FetchAudio;\n  private audio: AudioEngine = new DebugAudioEngine();\n  private audioset: Audioset = EmptyAudioset;\n\n  constructor() {\n    this.loader = new AudiosetLoader(status =>\n      this.setAudiosetLoadStatus(status),\n    );\n    this.controlListener = {\n      onControlStateChanged: state => this.emitControlState(state),\n      onControlCommand: command => this.runCommand(command),\n    };\n    this.resourceListener = (status: ResourceLoadStatus) => {\n      this.resourceStatusChanged.emit(status);\n    };\n    this.noControl = this.control = new AudiosetControl(\n      this.audioset,\n      this.controlListener,\n    );\n    this.noResources = this.resources = new ResourceLoader(\n      this.audioset,\n      this.resourceListener,\n    );\n    this.noSampler = this.sampler = new Sampler(\n      this.audioset,\n      this.resources,\n      this.audio,\n    );\n  }\n\n  public setFetchAudio(fetch: FetchAudio) {\n    this.fetchAudio = fetch;\n    this.resources.fetch = fetch;\n  }\n\n  public setAudioEngine(audio: AudioEngine) {\n    this.audio = audio;\n    // this.sampler.dispose()\n    this.sampler = new Sampler(this.audioset, this.resources, this.audio);\n  }\n\n  public onResourceStatusChanged(listener: Listener<ResourceLoadStatus>) {\n    return this.resourceStatusChanged.on(listener);\n  }\n\n  public onControlStateChanged(listener: Listener<ControlState>) {\n    return this.controlStateChanged.on(listener);\n  }\n\n  public onCommand(listener: Listener<ControlCommand>) {\n    return this.controlCommand.on(listener);\n  }\n\n  //// PRIVATE /////k\n\n  // allow pub/sub of contro state\n  private emitControlState(controlState: ControlState) {\n    this.controlStateChanged.emit(controlState);\n  }\n\n  // allows pub/sub of commands (for visuals)\n  private runCommand(command: ControlCommand) {\n    this.sampler.run(command);\n    this.controlCommand.emit(command);\n  }\n  private setAudiosetLoadStatus(status: AudiosetLoadStatus) {\n    this.audiosetLoadStatusChanged.emit(status);\n    if (status.status === \"ready\") {\n      this.setDelegates(status.audioset);\n      this.audiosetChanged.emit(status.audioset);\n    }\n  }\n\n  private setDelegates(audioset: AudiosetData) {\n    if (isAudiosetPlay(audioset)) {\n      this.audioset = audioset;\n      this.control = new AudiosetControl(audioset, this.controlListener);\n      this.resources = new ResourceLoader(audioset, this.resourceListener);\n      this.sampler = new Sampler(audioset, this.resources, this.audio);\n    } else {\n      this.control = this.noControl;\n      this.sampler = this.noSampler;\n      this.resources = this.noResources;\n    }\n    if (this.fetchAudio) {\n      this.resources.fetch = this.fetchAudio;\n    }\n  }\n}\n\nfunction isAudiosetPlay(audioset: AudiosetData): audioset is Audioset {\n  return audioset.type === \"audioset\";\n}\n"]},"metadata":{},"sourceType":"module"}