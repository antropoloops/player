{"ast":null,"code":"import { EmptyAudioset } from \"../audioset\";\nimport { AudiosetLoader } from \"../audioset/AudiosetLoader\";\nimport { DebugAudioEngine } from \"./Audio\";\nimport { AudiosetControl } from \"./AudiosetControl\";\nimport { Emitter } from \"./Emitter\";\nimport { ResourceLoader } from \"./ResourceLoader\";\nimport { Sampler } from \"./Sampler\";\n\nconst NoOp = param => undefined;\n\nconst NoControl = new AudiosetControl(EmptyAudioset, {\n  onControlCommand: NoOp,\n  onControlStateChanged: NoOp\n});\nconst NoResources = new ResourceLoader(EmptyAudioset, NoOp);\nconst NoEngine = new DebugAudioEngine();\nconst NoSampler = new Sampler(EmptyAudioset, NoResources, NoEngine);\n\nclass PlayerBase {\n  constructor() {\n    this.loader = void 0;\n    this.control = void 0;\n    this.resources = void 0;\n    this.loader = new AudiosetLoader(status => this.onLoadStatusChanged(status));\n    this.control = NoControl;\n    this.resources = NoResources;\n  }\n\n  onLoadStatusChanged(status) {}\n\n}\n/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */\n\n\nexport class Player extends PlayerBase {\n  // private //\n  constructor() {\n    this.controlListener = {\n      onControlStateChanged: state => this.emitControlState(state),\n      onControlCommand: command => this.runCommand(command)\n    };\n\n    this.resourceListener = status => {\n      this.resourceStatusChanged.emit(status);\n    };\n\n    this.sampler = NoSampler;\n  }\n\n  setAudioEngine(audio) {\n    this.audio = audio; // this.sampler.dispose()\n\n    this.sampler = new Sampler(this.audioset, this.resources, this.audio);\n  }\n\n  onResourceStatusChanged(listener) {\n    return this.resourceStatusChanged.on(listener);\n  }\n\n  onControlStateChanged(listener) {\n    return this.controlStateChanged.on(listener);\n  }\n\n  onCommand(listener) {\n    return this.controlCommand.on(listener);\n  }\n\n  onLoadStatusChanged(status) {\n    this.audiosetLoadStatusChanged.emit(status);\n\n    if (status.stage === \"ready\") {\n      this.setDelegates(status.audioset);\n      this.audiosetChanged.emit(status.audioset);\n    }\n  } //// PRIVATE /////\n  // allow pub/sub of contro state\n\n\n  emitControlState(controlState) {\n    this.controlStateChanged.emit(controlState);\n  } // allows pub/sub of commands (for visuals)\n\n\n  runCommand(command) {\n    this.sampler.run(command);\n    this.controlCommand.emit(command);\n  }\n\n  setDelegates(audioset) {\n    this.control.stopAll(0);\n\n    if (isAudiosetPlay(audioset)) {\n      this.audioset = audioset;\n      this.control = new AudiosetControl(audioset, this.controlListener);\n      this.resources = new ResourceLoader(audioset, this.resourceListener);\n      this.sampler = new Sampler(audioset, this.resources, this.audio);\n    } else {\n      this.control = NoControl;\n      this.sampler = NoSampler;\n      this.resources = NoResources;\n    }\n  }\n\n}\nexport class PlayerState extends Player {}\n\nfunction isAudiosetPlay(audioset) {\n  return audioset.type === \"audioset\";\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/PlayerState.ts"],"names":["EmptyAudioset","AudiosetLoader","DebugAudioEngine","AudiosetControl","Emitter","ResourceLoader","Sampler","NoOp","param","undefined","NoControl","onControlCommand","onControlStateChanged","NoResources","NoEngine","NoSampler","PlayerBase","constructor","loader","control","resources","status","onLoadStatusChanged","Player","controlListener","state","emitControlState","command","runCommand","resourceListener","resourceStatusChanged","emit","sampler","setAudioEngine","audio","audioset","onResourceStatusChanged","listener","on","controlStateChanged","onCommand","controlCommand","audiosetLoadStatusChanged","stage","setDelegates","audiosetChanged","controlState","run","stopAll","isAudiosetPlay","PlayerState","type"],"mappings":"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","sourcesContent":["import { Audioset, AudiosetData, EmptyAudioset } from \"../audioset\";\nimport { AudiosetLoader, AudiosetLoadStatus } from \"../audioset/AudiosetLoader\";\nimport { AudioEngine, DebugAudioEngine } from \"./Audio\";\nimport {\n  AudiosetControl,\n  ControlCommand,\n  ControlListener,\n  ControlState,\n} from \"./AudiosetControl\";\nimport { Emitter, Listener } from \"./Emitter\";\nimport { ResourceLoader, ResourceLoadStatus } from \"./ResourceLoader\";\nimport { Sampler } from \"./Sampler\";\n\nconst NoOp = (param: any) => undefined;\nconst NoControl = new AudiosetControl(EmptyAudioset, {\n  onControlCommand: NoOp,\n  onControlStateChanged: NoOp,\n});\nconst NoResources = new ResourceLoader(EmptyAudioset, NoOp);\nconst NoEngine = new DebugAudioEngine();\nconst NoSampler = new Sampler(EmptyAudioset, NoResources, NoEngine);\n\nclass PlayerBase {\n  public readonly loader: AudiosetLoader;\n  public control: AudiosetControl;\n  public resources: ResourceLoader;\n\n  constructor() {\n    this.loader = new AudiosetLoader(status =>\n      this.onLoadStatusChanged(status),\n    );\n    this.control = NoControl;\n    this.resources = NoResources;\n  }\n  public onLoadStatusChanged(status: AudiosetLoadStatus) {}\n}\n\n/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */\nexport class Player extends PlayerBase {\n  // private //\n  private sampler: Sampler;\n\n  private readonly controlListener: ControlListener;\n  private readonly resourceListener: (status: ResourceLoadStatus) => void;\n\n  private readonly audiosetChanged = new Emitter<AudiosetData>();\n  private readonly audiosetLoadStatusChanged = new Emitter<\n    AudiosetLoadStatus\n  >();\n  private readonly controlStateChanged = new Emitter<ControlState>();\n  private readonly controlCommand = new Emitter<ControlCommand>();\n  private readonly resourceStatusChanged = new Emitter<ResourceLoadStatus>();\n\n  private audio: AudioEngine = new DebugAudioEngine();\n  private audioset: Audioset = EmptyAudioset;\n\n  constructor() {\n    this.controlListener = {\n      onControlStateChanged: state => this.emitControlState(state),\n      onControlCommand: command => this.runCommand(command),\n    };\n    this.resourceListener = (status: ResourceLoadStatus) => {\n      this.resourceStatusChanged.emit(status);\n    };\n    this.sampler = NoSampler;\n  }\n\n  public setAudioEngine(audio: AudioEngine) {\n    this.audio = audio;\n    // this.sampler.dispose()\n    this.sampler = new Sampler(this.audioset, this.resources, this.audio);\n  }\n\n  public onResourceStatusChanged(listener: Listener<ResourceLoadStatus>) {\n    return this.resourceStatusChanged.on(listener);\n  }\n\n  public onControlStateChanged(listener: Listener<ControlState>) {\n    return this.controlStateChanged.on(listener);\n  }\n\n  public onCommand(listener: Listener<ControlCommand>) {\n    return this.controlCommand.on(listener);\n  }\n  public onLoadStatusChanged(status: AudiosetLoadStatus) {\n    this.audiosetLoadStatusChanged.emit(status);\n    if (status.stage === \"ready\") {\n      this.setDelegates(status.audioset);\n      this.audiosetChanged.emit(status.audioset);\n    }\n  }\n\n  //// PRIVATE /////\n\n  // allow pub/sub of contro state\n  private emitControlState(controlState: ControlState) {\n    this.controlStateChanged.emit(controlState);\n  }\n\n  // allows pub/sub of commands (for visuals)\n  private runCommand(command: ControlCommand) {\n    this.sampler.run(command);\n    this.controlCommand.emit(command);\n  }\n\n  private setDelegates(audioset: AudiosetData) {\n    this.control.stopAll(0);\n    if (isAudiosetPlay(audioset)) {\n      this.audioset = audioset;\n      this.control = new AudiosetControl(audioset, this.controlListener);\n      this.resources = new ResourceLoader(audioset, this.resourceListener);\n      this.sampler = new Sampler(audioset, this.resources, this.audio);\n    } else {\n      this.control = NoControl;\n      this.sampler = NoSampler;\n      this.resources = NoResources;\n    }\n  }\n}\n\nexport class PlayerState extends Player {}\n\nfunction isAudiosetPlay(audioset: AudiosetData): audioset is Audioset {\n  return audioset.type === \"audioset\";\n}\n\n"]},"metadata":{},"sourceType":"module"}