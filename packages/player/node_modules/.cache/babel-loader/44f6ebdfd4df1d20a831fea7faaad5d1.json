{"ast":null,"code":"import _regeneratorRuntime from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{useCallback,useEffect,useState}from\"react\";import{getActiveAudioContext}from\"../../../active-audio-context\";import{AudiosetControl,EmptyControlState}from\"../../../player/Control\";export function usePlayer(audioset,buffers){// Make visuals render after reference is set: https://dev.to/thekashey/the-same-useref-but-it-will-callback-8bo\nvar _useState=useState(null),_useState2=_slicedToArray(_useState,2),el=_useState2[0],setReference=_useState2[1];var visualsRef=useCallback(function(newRef){setReference(newRef);},[]);var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),control=_useState4[0],setControl=_useState4[1];var _useState5=useState(EmptyControlState),_useState6=_slicedToArray(_useState5,2),state=_useState6[0],setState=_useState6[1];useEffect(function(){var cancelled=false;var audio;var visuals;function createControl(){return _createControl.apply(this,arguments);}function _createControl(){_createControl=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var ctx,_yield$import,createAudioEffects,_yield$import2,createVisualEffects,ctl;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return getActiveAudioContext();case 2:ctx=_context.sent;if(!cancelled){_context.next=5;break;}return _context.abrupt(\"return\");case 5:_context.next=7;return import(\"../../../player/AudioEffects\");case 7:_yield$import=_context.sent;createAudioEffects=_yield$import.createAudioEffects;audio=createAudioEffects(audioset,ctx,buffers);if(!el){_context.next=17;break;}_context.next=13;return import(\"../../../player/VisualEffects\");case 13:_yield$import2=_context.sent;createVisualEffects=_yield$import2.createVisualEffects;visuals=createVisualEffects(audioset);visuals.attach(el);case 17:ctl=new AudiosetControl(audioset,{onControlStateChanged:function onControlStateChanged(newState){setState(newState);},onControlCommand:function onControlCommand(command){var _audio2,_visuals2;(_audio2=audio)===null||_audio2===void 0?void 0:_audio2.run(command);(_visuals2=visuals)===null||_visuals2===void 0?void 0:_visuals2.run(command);}});return _context.abrupt(\"return\",ctl);case 19:case\"end\":return _context.stop();}}},_callee);}));return _createControl.apply(this,arguments);}createControl().then(function(instance){if(instance){setControl(instance);setState(instance.getState());}});return function(){var _visuals,_audio;cancelled=true;(_visuals=visuals)===null||_visuals===void 0?void 0:_visuals.detach();(_audio=audio)===null||_audio===void 0?void 0:_audio.detach();};},[audioset,buffers,el]);return{visualsRef:visualsRef,control:control,state:state};}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/ui/components/Player/usePlayer.tsx"],"names":["useCallback","useEffect","useState","getActiveAudioContext","AudiosetControl","EmptyControlState","usePlayer","audioset","buffers","el","setReference","visualsRef","newRef","control","setControl","state","setState","cancelled","audio","visuals","createControl","ctx","createAudioEffects","createVisualEffects","attach","ctl","onControlStateChanged","newState","onControlCommand","command","run","then","instance","getState","detach"],"mappings":"idAAA,OAASA,WAAT,CAAsBC,SAAtB,CAAiCC,QAAjC,KAAiD,OAAjD,CACA,OAASC,qBAAT,KAAsC,+BAAtC,CAEA,OACEC,eADF,CAEEC,iBAFF,KAIO,yBAJP,CAQA,MAAO,SAASC,CAAAA,SAAT,CAAmBC,QAAnB,CAAuCC,OAAvC,CAA+D,CACpE;AADoE,cAEzCN,QAAQ,CAAwB,IAAxB,CAFiC,wCAE7DO,EAF6D,eAEzDC,YAFyD,eAGpE,GAAMC,CAAAA,UAAU,CAAGX,WAAW,CAAC,SAACY,MAAD,CAA4B,CACzDF,YAAY,CAACE,MAAD,CAAZ,CACD,CAF6B,CAE3B,EAF2B,CAA9B,CAHoE,eAOtCV,QAAQ,EAP8B,yCAO7DW,OAP6D,eAOpDC,UAPoD,8BAQ1CZ,QAAQ,CAACG,iBAAD,CARkC,yCAQ7DU,KAR6D,eAQtDC,QARsD,eAUpEf,SAAS,CAAC,UAAM,CACd,GAAIgB,CAAAA,SAAS,CAAG,KAAhB,CACA,GAAIC,CAAAA,KAAJ,CACA,GAAIC,CAAAA,OAAJ,CAHc,QAKCC,CAAAA,aALD,iJAKd,yOACoBjB,CAAAA,qBAAqB,EADzC,QACQkB,GADR,mBAGMJ,SAHN,uFAMuC,QACnC,8BADmC,CANvC,oCAMUK,kBANV,eAMUA,kBANV,CAUEJ,KAAK,CAAGI,kBAAkB,CAACf,QAAD,CAAWc,GAAX,CAAgBb,OAAhB,CAA1B,CAVF,IAYMC,EAZN,iDAa0C,QACpC,+BADoC,CAb1C,sCAaYc,mBAbZ,gBAaYA,mBAbZ,CAgBIJ,OAAO,CAAGI,mBAAmB,CAAChB,QAAD,CAA7B,CACAY,OAAO,CAACK,MAAR,CAAef,EAAf,EAjBJ,QAoBQgB,GApBR,CAoBc,GAAIrB,CAAAA,eAAJ,CAAoBG,QAApB,CAA8B,CACxCmB,qBAAqB,CAAE,+BAAAC,QAAQ,CAAI,CACjCX,QAAQ,CAACW,QAAD,CAAR,CACD,CAHuC,CAIxCC,gBAAgB,CAAE,0BAAAC,OAAO,CAAI,uBAC3B,SAAAX,KAAK,QAAL,kCAAOY,GAAP,CAAWD,OAAX,EACA,WAAAV,OAAO,QAAP,sCAASW,GAAT,CAAaD,OAAb,EACD,CAPuC,CAA9B,CApBd,iCA6BSJ,GA7BT,yDALc,gDAoCdL,aAAa,GAAGW,IAAhB,CAAqB,SAAAC,QAAQ,CAAI,CAC/B,GAAIA,QAAJ,CAAc,CACZlB,UAAU,CAACkB,QAAD,CAAV,CACAhB,QAAQ,CAACgB,QAAQ,CAACC,QAAT,EAAD,CAAR,CACD,CACF,CALD,EAOA,MAAO,WAAM,qBACXhB,SAAS,CAAG,IAAZ,CACA,UAAAE,OAAO,QAAP,oCAASe,MAAT,GACA,QAAAhB,KAAK,QAAL,gCAAOgB,MAAP,GACD,CAJD,CAKD,CAhDQ,CAgDN,CAAC3B,QAAD,CAAWC,OAAX,CAAoBC,EAApB,CAhDM,CAAT,CAkDA,MAAO,CAAEE,UAAU,CAAVA,UAAF,CAAcE,OAAO,CAAPA,OAAd,CAAuBE,KAAK,CAALA,KAAvB,CAAP,CACD","sourcesContent":["import { useCallback, useEffect, useState } from \"react\";\nimport { getActiveAudioContext } from \"../../../active-audio-context\";\nimport { Audioset } from \"../../../audioset\";\nimport {\n  AudiosetControl,\n  EmptyControlState,\n  PlayerControl,\n} from \"../../../player/Control\";\nimport { Effects } from \"../../../player/Control\";\nimport { SampleBuffers } from \"../../../sampler\";\n\nexport function usePlayer(audioset: Audioset, buffers: SampleBuffers) {\n  // Make visuals render after reference is set: https://dev.to/thekashey/the-same-useref-but-it-will-callback-8bo\n  const [el, setReference] = useState<HTMLDivElement | null>(null);\n  const visualsRef = useCallback((newRef: HTMLDivElement) => {\n    setReference(newRef);\n  }, []);\n\n  const [control, setControl] = useState<PlayerControl | undefined>();\n  const [state, setState] = useState(EmptyControlState);\n\n  useEffect(() => {\n    let cancelled = false;\n    let audio: Effects | undefined;\n    let visuals: Effects | undefined;\n\n    async function createControl() {\n      const ctx = await getActiveAudioContext();\n\n      if (cancelled) {\n        return;\n      }\n      const { createAudioEffects } = await import(\n        \"../../../player/AudioEffects\"\n      );\n\n      audio = createAudioEffects(audioset, ctx, buffers);\n\n      if (el) {\n        const { createVisualEffects } = await import(\n          \"../../../player/VisualEffects\"\n        );\n        visuals = createVisualEffects(audioset);\n        visuals.attach(el);\n      }\n\n      const ctl = new AudiosetControl(audioset, {\n        onControlStateChanged: newState => {\n          setState(newState);\n        },\n        onControlCommand: command => {\n          audio?.run(command);\n          visuals?.run(command);\n        },\n      });\n      return ctl;\n    }\n    createControl().then(instance => {\n      if (instance) {\n        setControl(instance);\n        setState(instance.getState());\n      }\n    });\n\n    return () => {\n      cancelled = true;\n      visuals?.detach();\n      audio?.detach();\n    };\n  }, [audioset, buffers, el]);\n\n  return { visualsRef, control, state };\n}\n"]},"metadata":{},"sourceType":"module"}