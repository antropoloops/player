{"ast":null,"code":"import _regeneratorRuntime from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _classCallCheck from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import debug from\"debug\";import{decodeAudioBuffer}from\"./decodeAudioBuffer\";var log=debug(\"atpls:resources\");// TODO: abstract the loader mechanism: { stage, payload }\nexport var ResourceLoader=/*#__PURE__*/function(){function ResourceLoader(audioset,listener){var _this=this;_classCallCheck(this,ResourceLoader);this.audioset=audioset;this.listener=listener;this.status=void 0;this.total=void 0;this.completed=void 0;this.buffers={};this.preloaded=void 0;log(\"create ResourceLoader %s\",audioset.id);this.status={stage:\"pending\"};this.preloaded=false;this.total=this.audioset.clips.length;this.completed=0;setTimeout(function(){_this.preload();},2000);}_createClass(ResourceLoader,[{key:\"getStatus\",value:function getStatus(){return this.status;}},{key:\"getBuffer\",value:function getBuffer(clipId){return this.buffers[clipId];}},{key:\"load\",value:function load(context){var _this2=this;this.preload();var total=this.total,completed=this.completed;if(total===completed){return Promise.resolve();}log(\"Start clip audio loading [%s]\",this.audioset.meta.title);this.setStatus({stage:\"loading\",total:total,completed:0});var clips=this.audioset.clips;if(clips[0]){log(\"Audio format %s\",clips[0].resources.audio.ogg?\"ogg\":\"mp3\");}var promises=clips.map(function(clip){return _this2.loadClipAudio(clip,context).catch(function(err){_this2.handleResourceCompleted();log(\"Error %o\",err);});});return Promise.all(promises);}},{key:\"preload\",value:function preload(){if(this.preloaded){return Promise.resolve();}log(\"Preload\");this.preloaded=true;var _this$audioset=this.audioset,visuals=_this$audioset.visuals,clips=_this$audioset.clips;var promises=[];if(visuals.mode===\"map\"&&visuals.geomap.url){promises.push(fetch(visuals.geomap.url));}clips.forEach(function(clip){preloadImage(clip.resources.cover.small);});var loadAll=function loadAll(){log(\"Preload images\");return Promise.all(promises);};return preloadImage(this.audioset.meta.logo_url).then(loadAll).catch(loadAll);}//// PRIVATE ////\n},{key:\"setStatus\",value:function setStatus(status){if(status.stage!==\"loading\"){log(\"stage %s\",status.stage);}this.status=status;this.listener(status);}},{key:\"loadClipAudio\",value:function loadClipAudio(clip,context){var audio,url,response,buffer;return _regeneratorRuntime.async(function loadClipAudio$(_context){while(1){switch(_context.prev=_context.next){case 0:audio=clip.resources.audio;url=audio.ogg||audio.mp3;_context.next=4;return _regeneratorRuntime.awrap(fetch(url));case 4:response=_context.sent;_context.next=7;return _regeneratorRuntime.awrap(decodeAudioBuffer(response,context));case 7:buffer=_context.sent;this.buffers[clip.id]=buffer;this.handleResourceCompleted(url);return _context.abrupt(\"return\",buffer);case 11:case\"end\":return _context.stop();}}},null,this);}},{key:\"handleResourceCompleted\",value:function handleResourceCompleted(url){this.completed+=1;var status=this.completed>=this.total?{stage:\"ready\",total:this.total}:{stage:\"loading\",total:this.total,completed:this.completed};this.setStatus(status);}}]);return ResourceLoader;}();function preloadImage(url){if(!url||!url.length){return Promise.resolve();}return new Promise(function(resolve){var image=new Image();image.addEventListener(\"load\",function(){resolve(image);});image.src=url;});}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/Loader/ResourceLoader.ts"],"names":["debug","decodeAudioBuffer","log","ResourceLoader","audioset","listener","status","total","completed","buffers","preloaded","id","stage","clips","length","setTimeout","preload","clipId","context","Promise","resolve","meta","title","setStatus","resources","audio","ogg","promises","map","clip","loadClipAudio","catch","err","handleResourceCompleted","all","visuals","mode","geomap","url","push","fetch","forEach","preloadImage","cover","small","loadAll","logo_url","then","mp3","response","buffer","image","Image","addEventListener","src"],"mappings":"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","sourcesContent":["import debug from \"debug\";\nimport { IAudioContext } from \"standardized-audio-context\";\nimport { Audioset, Clip } from \"../../audioset\";\nimport { decodeAudioBuffer } from \"./decodeAudioBuffer\";\n\nconst log = debug(\"atpls:resources\");\n\n// TODO: abstract the loader mechanism: { stage, payload }\nexport interface LoadPending {\n  stage: \"pending\";\n}\nexport interface LoadingResources {\n  stage: \"loading\";\n  total: number;\n  completed: number;\n}\nexport interface ResourcesLoaded {\n  stage: \"ready\";\n  total: number;\n}\nexport interface ResourceLoadError {\n  stage: \"error\";\n  error: any;\n}\n\nexport type ResourceLoadStatus =\n  | LoadPending\n  | LoadingResources\n  | ResourcesLoaded\n  | ResourceLoadError;\n\nexport interface Resources {\n  getStatus(): ResourceLoadStatus;\n  getBuffer(clipId: string): any;\n  load(ctx: IAudioContext): Promise<any>;\n}\n\nexport class ResourceLoader implements Resources {\n  public status: ResourceLoadStatus;\n  private total: number;\n  private completed: number;\n  private buffers: Record<string, any> = {};\n  private preloaded: boolean;\n\n  constructor(\n    private audioset: Audioset,\n    private listener: (status: ResourceLoadStatus) => void,\n  ) {\n    log(\"create ResourceLoader %s\", audioset.id);\n    this.status = { stage: \"pending\" };\n    this.preloaded = false;\n    this.total = this.audioset.clips.length;\n    this.completed = 0;\n    setTimeout(() => {\n      this.preload();\n    }, 2000);\n  }\n\n  public getStatus() {\n    return this.status;\n  }\n\n  public getBuffer(clipId: string): any {\n    return this.buffers[clipId];\n  }\n\n  public load(context: IAudioContext) {\n    this.preload();\n    const { total, completed } = this;\n    if (total === completed) {\n      return Promise.resolve();\n    }\n\n    log(\"Start clip audio loading [%s]\", this.audioset.meta.title);\n    this.setStatus({ stage: \"loading\", total, completed: 0 });\n    const clips = this.audioset.clips;\n    if (clips[0]) {\n      log(\"Audio format %s\", clips[0].resources.audio.ogg ? \"ogg\" : \"mp3\");\n    }\n    const promises = clips.map(clip =>\n      this.loadClipAudio(clip, context).catch(err => {\n        this.handleResourceCompleted();\n        log(\"Error %o\", err);\n      }),\n    );\n    return Promise.all(promises);\n  }\n\n  private preload() {\n    if (this.preloaded) {\n      return Promise.resolve();\n    }\n\n    log(\"Preload\");\n    this.preloaded = true;\n    const { visuals, clips } = this.audioset;\n    const promises: Array<Promise<any>> = [];\n    if (visuals.mode === \"map\" && visuals.geomap.url) {\n      promises.push(fetch(visuals.geomap.url));\n    }\n    clips.forEach(clip => {\n      preloadImage(clip.resources.cover.small);\n    });\n    const loadAll = () => {\n      log(\"Preload images\");\n      return Promise.all(promises);\n    };\n\n    return preloadImage(this.audioset.meta.logo_url)\n      .then(loadAll)\n      .catch(loadAll);\n  }\n\n  //// PRIVATE ////\n  private setStatus(status: ResourceLoadStatus) {\n    if (status.stage !== \"loading\") {\n      log(\"stage %s\", status.stage);\n    }\n    this.status = status;\n    this.listener(status);\n  }\n\n  private async loadClipAudio(clip: Clip, context: IAudioContext) {\n    const { audio } = clip.resources;\n    const url = audio.ogg || audio.mp3;\n    const response = await fetch(url);\n    const buffer = await decodeAudioBuffer(response, context);\n    this.buffers[clip.id] = buffer;\n    this.handleResourceCompleted(url);\n\n    return buffer;\n  }\n\n  private handleResourceCompleted(url?: string) {\n    this.completed += 1;\n    const status: ResourceLoadStatus =\n      this.completed >= this.total\n        ? { stage: \"ready\", total: this.total }\n        : { stage: \"loading\", total: this.total, completed: this.completed };\n    this.setStatus(status);\n  }\n}\n\nfunction preloadImage(url: string): Promise<any> {\n  if (!url || !url.length) {\n    return Promise.resolve();\n  }\n  return new Promise(resolve => {\n    const image = new Image();\n    image.addEventListener(\"load\", () => {\n      resolve(image);\n    });\n    image.src = url;\n  });\n}\n"]},"metadata":{},"sourceType":"module"}