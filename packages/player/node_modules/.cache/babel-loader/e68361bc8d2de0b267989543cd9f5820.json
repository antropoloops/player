{"ast":null,"code":"import _classCallCheck from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";import _createClass from\"/Users/dani/Antropoloops/atpls-player/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";import debug from\"debug\";var log=debug(\"atpls:keyboard\");export var KeyboardControler=/*#__PURE__*/function(){function KeyboardControler(audioset,control){var _this=this;_classCallCheck(this,KeyboardControler);this.control=control;this.active=false;this.pressed={};this.clipIdToKey={};this.keyToClipId={};this.mapMode=undefined;audioset.clips.forEach(function(clip){var key=clip.keyMap.toUpperCase();_this.clipIdToKey[clip.id]=key;_this.keyToClipId[key]=clip.id;});}_createClass(KeyboardControler,[{key:\"getKey\",value:function getKey(clipId){return this.clipIdToKey[clipId];}},{key:\"setActive\",value:function setActive(isActive){this.active=isActive;log(\"setActive %o\",isActive);}},{key:\"startMapMode\",value:function startMapMode(clipId,callback){this.mapMode={clipId:clipId,callback:callback};}},{key:\"stopMapMode\",value:function stopMapMode(){this.mapMode=undefined;}},{key:\"setKey\",value:function setKey(clipId,key){var oldKey=this.clipIdToKey[clipId];if(oldKey){this.keyToClipId[oldKey]=undefined;}key=key.toUpperCase();this.keyToClipId[key]=clipId;this.clipIdToKey[clipId]=key;}},{key:\"keyDown\",value:function keyDown(key){if(!this.active){return;}key=key.toUpperCase();if(this.mapMode){return this.handleKeymapChange(key);}else if(this.pressed[key]){return;}this.pressed[key]=true;var clipId=this.keyToClipId[key];if(clipId){this.control.startClip(clipId,0);}}},{key:\"keyUp\",value:function keyUp(key){if(!this.active||this.mapMode){return;}key=key.toUpperCase();this.pressed[key]=false;var clipId=this.keyToClipId[key];if(clipId){this.control.stopClip(clipId,0);}}},{key:\"handleKeymapChange\",value:function handleKeymapChange(key){if(!this.mapMode){return;}if(key!==\"ESCAPE\"){this.setKey(this.mapMode.clipId,key);}this.mapMode.callback(key);this.mapMode=undefined;}}]);return KeyboardControler;}();","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/Control/KeyboardControler.ts"],"names":["debug","log","KeyboardControler","audioset","control","active","pressed","clipIdToKey","keyToClipId","mapMode","undefined","clips","forEach","clip","key","keyMap","toUpperCase","id","clipId","isActive","callback","oldKey","handleKeymapChange","startClip","stopClip","setKey"],"mappings":"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","sourcesContent":["import { Audioset } from \"../../audioset\";\n\nimport debug from \"debug\";\n\nconst log = debug(\"atpls:keyboard\");\n\nexport interface Control {\n  startClip(clipId: string, time: number): void;\n  stopClip(clipId: string, time: number): void;\n}\n\ntype MapModeCallback = (newKey: string) => void;\ninterface MapMode {\n  clipId: string;\n  callback: MapModeCallback;\n}\n\nexport class KeyboardControler {\n  private active: boolean = false;\n  private pressed: Record<string, boolean> = {};\n  private clipIdToKey: Record<string, string> = {};\n  private keyToClipId: Record<string, string | undefined> = {};\n  private mapMode?: MapMode = undefined;\n\n  constructor(audioset: Audioset, private control: Control) {\n    audioset.clips.forEach(clip => {\n      const key = clip.keyMap.toUpperCase();\n      this.clipIdToKey[clip.id] = key;\n      this.keyToClipId[key] = clip.id;\n    });\n  }\n\n  public getKey(clipId: string) {\n    return this.clipIdToKey[clipId];\n  }\n\n  public setActive(isActive: boolean) {\n    this.active = isActive;\n    log(\"setActive %o\", isActive);\n  }\n\n  public startMapMode(clipId: string, callback: MapModeCallback) {\n    this.mapMode = { clipId, callback };\n  }\n  public stopMapMode() {\n    this.mapMode = undefined;\n  }\n\n  public setKey(clipId: string, key: string) {\n    const oldKey = this.clipIdToKey[clipId];\n    if (oldKey) {\n      this.keyToClipId[oldKey] = undefined;\n    }\n    key = key.toUpperCase();\n    this.keyToClipId[key] = clipId;\n    this.clipIdToKey[clipId] = key;\n  }\n\n  public keyDown(key: string) {\n    if (!this.active) {\n      return;\n    }\n\n    key = key.toUpperCase();\n    if (this.mapMode) {\n      return this.handleKeymapChange(key);\n    } else if (this.pressed[key]) {\n      return;\n    }\n    this.pressed[key] = true;\n\n    const clipId = this.keyToClipId[key];\n    if (clipId) {\n      this.control.startClip(clipId, 0);\n    }\n  }\n  public keyUp(key: string) {\n    if (!this.active || this.mapMode) {\n      return;\n    }\n\n    key = key.toUpperCase();\n    this.pressed[key] = false;\n\n    const clipId = this.keyToClipId[key];\n    if (clipId) {\n      this.control.stopClip(clipId, 0);\n    }\n  }\n\n  private handleKeymapChange(key: string) {\n    if (!this.mapMode) {\n      return;\n    }\n    if (key !== \"ESCAPE\") {\n      this.setKey(this.mapMode.clipId, key);\n    }\n    this.mapMode.callback(key);\n    this.mapMode = undefined;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}