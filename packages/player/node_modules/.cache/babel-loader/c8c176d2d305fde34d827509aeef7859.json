{"ast":null,"code":"import { EmptyAudioset } from \"../audioset\";\nimport { AudiosetLoader } from \"../audioset/AudiosetLoader\";\nimport { DebugAudioEngine } from \"./Audio\";\nimport { AudiosetControl } from \"./AudiosetControl\";\nimport { Emitter } from \"./Emitter\";\nimport { ResourceLoader } from \"./ResourceLoader\";\nimport { Sampler } from \"./Sampler\";\n\nconst NoOp = param => undefined;\n\nconst NoControl = new AudiosetControl(EmptyAudioset, {\n  onControlCommand: NoOp,\n  onControlStateChanged: NoOp\n});\nconst NoResources = new ResourceLoader(EmptyAudioset, NoOp);\nconst NoEngine = new DebugAudioEngine();\nconst NoSampler = new Sampler(EmptyAudioset, NoResources, NoEngine);\nconst NoPlayer = {\n  control: NoControl,\n  resources: NoResources,\n  sampler: NoSampler\n};\n\nclass EmptyPlayer {\n  constructor() {\n    this.resources = NoResources;\n    this.sampler = NoSampler;\n    this.control = NoControl;\n  }\n\n}\n\nclass AudiosetPlayer extends EmptyPlayer {\n  constructor(...args) {\n    super(...args);\n    this.audioset = EmptyAudioset;\n  }\n\n}\n/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */\n\n\nexport class Player extends AudiosetPlayer {\n  constructor() {\n    super();\n    this.controlListener = void 0;\n    this.resourceListener = void 0;\n    this.controlStateChanged = new Emitter();\n    this.controlCommand = new Emitter();\n    this.resourceStatusChanged = new Emitter();\n    this.controlListener = {\n      onControlStateChanged: state => this.handleControlStateChanged(state),\n      onControlCommand: command => this.handleControlCommand(command)\n    };\n\n    this.resourceListener = status => {\n      this.handleResourceChanged(status);\n    };\n\n    this.sampler = NoSampler;\n  }\n\n  onResourceStatusChanged(listener) {\n    return this.resourceStatusChanged.on(listener);\n  }\n\n  onControlStateChanged(listener) {\n    return this.controlStateChanged.on(listener);\n  }\n\n  onCommand(listener) {\n    return this.controlCommand.on(listener);\n  }\n\n  handleResourceChanged(status) {\n    this.resourceStatusChanged.emit(status);\n  }\n\n  handleControlStateChanged(controlState) {\n    this.controlStateChanged.emit(controlState);\n  }\n\n  handleControlCommand(command) {\n    this.sampler.run(command);\n    this.controlCommand.emit(command);\n  }\n\n}\n\nclass AudioPlayer extends Player {\n  constructor(...args) {\n    super(...args);\n    this.audio = new DebugAudioEngine();\n  }\n\n  setAudioEngine(audio) {\n    this.audio = audio; // this.sampler.dispose()\n\n    this.sampler = new Sampler(this.audioset, this.resources, this.audio);\n  }\n\n}\n\nexport class PlayerState extends AudioPlayer {\n  constructor() {\n    super();\n    this.loader = void 0;\n    this.audiosetLoadStatusChanged = new Emitter();\n    this.loader = new AudiosetLoader(status => this.handleLoadStatusChanged(status));\n  }\n\n  handleLoadStatusChanged(status) {\n    this.audiosetLoadStatusChanged.emit(status);\n\n    if (status.stage === \"ready\") {\n      this.setAudiosetData(status.audioset);\n    }\n  }\n\n  setAudiosetData(audioset) {\n    this.control.stopAll(0);\n\n    if (isAudiosetPlay(audioset)) {\n      this.audioset = audioset;\n      this.control = new AudiosetControl(audioset, this.controlListener);\n      this.resources = new ResourceLoader(audioset, this.resourceListener);\n      this.sampler = new Sampler(audioset, this.resources, this.audio);\n    } else {\n      Object.assign(this, NoPlayer);\n    }\n  }\n\n}\n\nfunction isAudiosetPlay(audioset) {\n  return audioset.type === \"audioset\";\n}","map":{"version":3,"sources":["/Users/dani/Antropoloops/atpls-player/src/player/PlayerState.ts"],"names":["EmptyAudioset","AudiosetLoader","DebugAudioEngine","AudiosetControl","Emitter","ResourceLoader","Sampler","NoOp","param","undefined","NoControl","onControlCommand","onControlStateChanged","NoResources","NoEngine","NoSampler","NoPlayer","control","resources","sampler","EmptyPlayer","AudiosetPlayer","audioset","Player","constructor","controlListener","resourceListener","controlStateChanged","controlCommand","resourceStatusChanged","state","handleControlStateChanged","command","handleControlCommand","status","handleResourceChanged","onResourceStatusChanged","listener","on","onCommand","emit","controlState","run","AudioPlayer","audio","setAudioEngine","PlayerState","loader","audiosetLoadStatusChanged","handleLoadStatusChanged","stage","setAudiosetData","stopAll","isAudiosetPlay","Object","assign","type"],"mappings":"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","sourcesContent":["import { Audioset, AudiosetData, EmptyAudioset } from \"../audioset\";\nimport { AudiosetLoader, AudiosetLoadStatus } from \"../audioset/AudiosetLoader\";\nimport { AudioEngine, DebugAudioEngine } from \"./Audio\";\nimport {\n  AudiosetControl,\n  ControlCommand,\n  ControlListener,\n  ControlState,\n} from \"./AudiosetControl\";\nimport { Emitter, Listener } from \"./Emitter\";\nimport { ResourceLoader, ResourceLoadStatus } from \"./ResourceLoader\";\nimport { Sampler } from \"./Sampler\";\n\nconst NoOp = (param: any) => undefined;\nconst NoControl = new AudiosetControl(EmptyAudioset, {\n  onControlCommand: NoOp,\n  onControlStateChanged: NoOp,\n});\nconst NoResources = new ResourceLoader(EmptyAudioset, NoOp);\nconst NoEngine = new DebugAudioEngine();\nconst NoSampler = new Sampler(EmptyAudioset, NoResources, NoEngine);\n\nconst NoPlayer = {\n  control: NoControl,\n  resources: NoResources,\n  sampler: NoSampler,\n};\n\nclass EmptyPlayer {\n  public resources: ResourceLoader = NoResources;\n  public sampler: Sampler = NoSampler;\n  public control: AudiosetControl = NoControl;\n}\n\nclass AudiosetPlayer extends EmptyPlayer {\n  public audioset: Audioset = EmptyAudioset;\n}\n\n/**\n * A player is the facade for the rest of the components:\n * - Loader: load audioset and resources\n * - Control: determines how to play clips\n * - Pads: receive pad events\n * - Params: receive param change events\n * - Keyboard: receive keyboard events\n * - Sampler: play the audio\n */\nexport class Player extends AudiosetPlayer {\n  protected readonly controlListener: ControlListener;\n  protected readonly resourceListener: (status: ResourceLoadStatus) => void;\n\n  private readonly controlStateChanged = new Emitter<ControlState>();\n  private readonly controlCommand = new Emitter<ControlCommand>();\n  private readonly resourceStatusChanged = new Emitter<ResourceLoadStatus>();\n\n  constructor() {\n    super();\n    this.controlListener = {\n      onControlStateChanged: state => this.handleControlStateChanged(state),\n      onControlCommand: command => this.handleControlCommand(command),\n    };\n    this.resourceListener = (status: ResourceLoadStatus) => {\n      this.handleResourceChanged(status);\n    };\n    this.sampler = NoSampler;\n  }\n\n  public onResourceStatusChanged(listener: Listener<ResourceLoadStatus>) {\n    return this.resourceStatusChanged.on(listener);\n  }\n\n  public onControlStateChanged(listener: Listener<ControlState>) {\n    return this.controlStateChanged.on(listener);\n  }\n\n  public onCommand(listener: Listener<ControlCommand>) {\n    return this.controlCommand.on(listener);\n  }\n\n  private handleResourceChanged(status: ResourceLoadStatus) {\n    this.resourceStatusChanged.emit(status);\n  }\n\n  private handleControlStateChanged(controlState: ControlState) {\n    this.controlStateChanged.emit(controlState);\n  }\n\n  private handleControlCommand(command: ControlCommand) {\n    this.sampler.run(command);\n    this.controlCommand.emit(command);\n  }\n}\n\nclass AudioPlayer extends Player {\n  private audio: AudioEngine = new DebugAudioEngine();\n\n  public setAudioEngine(audio: AudioEngine) {\n    this.audio = audio;\n    // this.sampler.dispose()\n    this.sampler = new Sampler(this.audioset, this.resources, this.audio);\n  }\n}\n\nexport class PlayerState extends AudioPlayer {\n  public readonly loader: AudiosetLoader;\n  private readonly audiosetLoadStatusChanged = new Emitter<\n    AudiosetLoadStatus\n  >();\n\n  constructor() {\n    super();\n    this.loader = new AudiosetLoader(status =>\n      this.handleLoadStatusChanged(status),\n    );\n  }\n\n  private handleLoadStatusChanged(status: AudiosetLoadStatus) {\n    this.audiosetLoadStatusChanged.emit(status);\n    if (status.stage === \"ready\") {\n      this.setAudiosetData(status.audioset);\n    }\n  }\n\n  private setAudiosetData(audioset: AudiosetData) {\n    this.control.stopAll(0);\n    if (isAudiosetPlay(audioset)) {\n      this.audioset = audioset;\n      this.control = new AudiosetControl(audioset, this.controlListener);\n      this.resources = new ResourceLoader(audioset, this.resourceListener);\n      this.sampler = new Sampler(audioset, this.resources, this.audio);\n    } else {\n      Object.assign(this, NoPlayer);\n    }\n  }\n}\n\nfunction isAudiosetPlay(audioset: AudiosetData): audioset is Audioset {\n  return audioset.type === \"audioset\";\n}\n\n"]},"metadata":{},"sourceType":"module"}